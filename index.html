<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ©ã‚¤ãƒ‰ãƒ„ãƒ¼ãƒªãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ï¼ˆLINE Ã— Google Mapsï¼‰</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: sans-serif; }
    header { padding: 10px 16px; background: #06c755; color: white; }
    h1 { font-size: 18px; margin: 0; }

    #map { width: 100%; height: 50vh; }
    @media (min-width: 769px){ #map { height: 60vh; } }

    .panel { padding: 12px 16px; background:#fff; }
    input, select { padding: 8px; width: 100%; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 6px; }
    button { padding: 10px; font-size: 16px; border: none; border-radius: 8px; background: #06c755; color: white; width: 100%; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: default; }
    label.chk { display:flex; gap:6px; align-items:center; margin-right:12px; }

    body.fullmap header, body.fullmap #controls { display: none; }
    body.fullmap #map { height: 100vh !important; }

    #back { position: fixed; top: 10px; left: 10px; z-index: 1000; background: #06c755; color: #fff; border: none; border-radius: 8px; padding: 8px 12px; display: none; }
    body.fullmap #back { display: inline-block; }

    #fab {
      position: fixed; right: 12px; bottom: 16px; z-index: 1001;
      gap: 8px; display: none; flex-direction: column; align-items: end;
    }
    #fab button {
      padding: 10px 14px; border: none; border-radius: 20px; background: #06c755; color: #fff;
      font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,.2); white-space: nowrap; width: auto; cursor: pointer;
    }
    body.fullmap #fab { display: flex; }

    #jumpCtl { position: fixed; right: 12px; bottom: 16px; z-index: 1000;
      padding: 10px 14px; border: none; border-radius: 20px; background: #06c755; color:#fff; font-size: 14px; box-shadow:0 2px 8px rgba(0,0,0,.2); }
    body.fullmap #jumpCtl { display:none; }

    #stopsDrawer {
      position: fixed; right: 12px; top: 12px; z-index: 1001;
      background: rgba(255,255,255,0.98); border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.2);
      width: min(360px, 92vw); max-height: 72vh; display: none; flex-direction: column;
    }
    #stopsDrawer header { display:flex; justify-content: space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #eee; }
    #stopsList { overflow:auto; max-height: 54vh; padding: 8px 10px; }
    .stopItem { border: 1px solid #eee; border-radius: 10px; padding: 8px 10px; margin-bottom: 8px; cursor: pointer; }
    .stopItem:hover { background: #fafafa; }
    .meta { color:#666; font-size:12px; display:flex; gap:8px; flex-wrap:wrap; }
    .controls { padding:10px 12px; display:flex; gap:10px; align-items:center; border-bottom:1px solid #eee; flex-wrap:wrap; }
    .controls .group { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .badge { background:#06c755; color:#fff; border-radius:12px; padding:2px 8px; font-size:12px; }
  </style>
</head>
<body>
  <header><h1>ãƒ©ã‚¤ãƒ‰ãƒ„ãƒ¼ãƒªãƒ³ã‚°ãƒ„ãƒ¼ãƒ«</h1></header>

  <button id="jumpCtl" type="button">æ“ä½œãƒ‘ãƒãƒ«</button>
  <div id="map"></div>

  <div id="controls" class="panel">
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="start" placeholder="å‡ºç™ºåœ°ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šäº¬éƒ½é§…ï¼‰" style="flex:1">
      <button type="button" id="btn-loc" style="width:auto; white-space:nowrap;">ç¾åœ¨åœ°</button>
    </div>
    <input id="end" placeholder="ç›®çš„åœ°ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šç¾å±± ã‹ã‚„ã¶ãã®é‡Œï¼‰">
    <div style="display:flex; gap:12px; align-items:center; margin:6px 0 10px; flex-wrap:wrap;">
      <label class="chk"><input type="checkbox" id="opt-avoid-highways"> é«˜é€Ÿã‚’ä½¿ã‚ãªã„</label>
      <label class="chk"><input type="checkbox" id="opt-avoid-tolls"> æœ‰æ–™é“è·¯ã‚’ä½¿ã‚ãªã„</label>
    </div>
    <button id="makeRoute">ãƒ«ãƒ¼ãƒˆã‚’ä½œã‚‹</button>
    <button id="shareBtn" disabled>LINEã§å…±æœ‰</button>
    <button id="navBtn" disabled>GoogleãƒŠãƒ“ã§é–‹ã</button>
    <button id="stopsBtn" disabled>ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆææ¡ˆ</button>
  </div>

  <div id="summaryPanel" class="panel" style="padding-top:8px">
    <div id="summary" style="font-size:14px;line-height:1.6;color:#333">è·é›¢ã¨æ™‚é–“ã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
  </div>

  <button id="back" type="button">æˆ»ã‚‹</button>
  <div id="fab">
    <button id="navBtnFab" disabled>GoogleãƒŠãƒ“é–‹å§‹</button>
    <button id="shareBtnFab" disabled>LINEã§å…±æœ‰</button>
    <button id="stopsBtnFab" disabled>ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆææ¡ˆ</button>
  </div>

  <!-- ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆ ãƒ‰ãƒ­ãƒ¯ãƒ¼ -->
  <div id="stopsDrawer">
    <header>
      <div>ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆå€™è£œ <span id="stopsCount" class="badge">0ä»¶</span></div>
      <button id="stopsClose" style="width:auto;background:#999;">é–‰ã˜ã‚‹</button>
    </header>
    <div class="controls">
      <div class="group">
        <label class="chk"><input type="checkbox" class="stop-type" value="é“ã®é§…" checked>é“ã®é§…</label>
        <label class="chk"><input type="checkbox" class="stop-type" value="cafe" checked>ã‚«ãƒ•ã‚§</label>
        <label class="chk"><input type="checkbox" class="stop-type" value="gas_station" checked>GS</label>
        <label class="chk"><input type="checkbox" class="stop-type" value="parking" checked>é§è»Šå ´</label>
        <label class="chk"><input type="checkbox" class="stop-type" value="tourist_attraction">è¦³å…‰</label>
      </div>
      <div class="group">
        åŠå¾„
        <select id="stopRadius" style="width:auto;">
          <option value="2000">2km</option>
          <option value="3000">3km</option>
          <option value="5000">5km</option>
          <option value="8000">8km</option>
          <option value="20000" selected>20km</option>
          <option value="30000">30km</option>
        </select>
        <label class="chk"><input type="checkbox" id="onlyOpen">å–¶æ¥­ä¸­ã®ã¿</label>
      </div>
      <button id="stopsRefresh" style="width:auto;">å†æ¤œç´¢</button>
    </div>
    <div id="stopsList"></div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = "2008438848-3gJlGQvy";
    (async function initLIFFSafe() {
      try { if (window.liff) { await liff.init({ liffId: LIFF_ID }); } }
      catch(e){ console.warn('LIFF init skipped:', e); }
    })();
  </script>

  <script>
    let map, directionsService, directionsRenderer, geocoder, placesService, currentMarker, infoWnd;
    let lastRouteResult = null;
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    let stopMarkers = [];
    const stopIcon = { cafe:"â˜•", gas_station:"â›½", parking:"ğŸ…¿", tourist_attraction:"ğŸ“", michi:"ğŸ¯" };
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlN9ik-Y3CpEy3Uw9hXfBq0m2AoZWx_oM&libraries=places,geometry&language=ja&region=JP&callback=initMap" async defer></script>

  <script>
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), { center: { lat: 35.0116, lng: 135.7681 }, zoom: 9 });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map });
      geocoder = new google.maps.Geocoder();
      placesService = new google.maps.places.PlacesService(map);
      infoWnd = new google.maps.InfoWindow();
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('makeRoute').addEventListener('click', makeRoute);
      document.getElementById('shareBtn').addEventListener('click', shareOnLINE);
      document.getElementById('navBtn').addEventListener('click', openNavigation);
      document.getElementById('stopsBtn').addEventListener('click', () => suggestStops(true));
      document.getElementById('btn-loc').addEventListener('click', fillWithCurrentLocation);
      document.getElementById('shareBtnFab').addEventListener('click', shareOnLINE);
      document.getElementById('navBtnFab').addEventListener('click', openNavigation);
      document.getElementById('stopsBtnFab').addEventListener('click', () => suggestStops(true));
      document.getElementById('back').addEventListener('click', () => {
        document.body.classList.remove('fullmap');
        if (window.google && map) google.maps.event.trigger(map, 'resize');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
      document.getElementById('stopsClose').addEventListener('click', () => {
        document.getElementById('stopsDrawer').style.display = 'none';
      });
      document.getElementById('stopsRefresh').addEventListener('click', () => suggestStops(false));
      document.getElementById('jumpCtl').addEventListener('click', () => {
        document.getElementById('controls').scrollIntoView({ behavior:'smooth', block:'start' });
      });
    });

    // çœç•¥ï¼šmakeRoute()ãªã©æ—¢å­˜éƒ¨åˆ†ã¯åŒã˜
    // â†“ ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆã®ã‚¯ãƒªãƒƒã‚¯ä¿®æ­£æ¸ˆã¿éƒ¨åˆ†ã ã‘æŠœç²‹ â†“

    function renderStops(results, leg) {
      const list = document.getElementById('stopsList'); list.innerHTML = '';
      document.getElementById('stopsCount').textContent = `${results.length}ä»¶`;

      results.forEach(place => {
        const pos = place.geometry.location;
        const typeKey = (place.types||[]).find(t => stopIcon[t]) ? (place.types||[]).find(t => stopIcon[t]) : (place.name.includes('é“ã®é§…') ? 'michi' : 'tourist_attraction');
        const marker = new google.maps.Marker({
          position: pos, map, label: { text: stopIcon[typeKey] || 'ğŸ“', color: '#000', fontSize: '16px' }
        });
        // ä¿®æ­£ç‰ˆ
        marker.addListener('click', () => openInfo(place, leg));
        stopMarkers.push(marker);

        const item = document.createElement('div');
        item.className = 'stopItem';
        const distDur = estimateDetour(leg, pos);
        item.innerHTML = `
          <div style="font-weight:700">${place.name}</div>
          <div class="meta">
            <span>${place.vicinity || place.formatted_address || ''}</span>
            <span>â˜…${place.rating || '-'}ï¼ˆ${place.user_ratings_total || 0}ä»¶ï¼‰</span>
            ${distDur ? `<span>${distDur}</span>` : ''}
            ${place.opening_hours?.open_now !== undefined ? `<span>${place.opening_hours.open_now ? 'å–¶æ¥­ä¸­' : 'å–¶æ¥­æ™‚é–“å¤–'}</span>` : ''}
          </div>`;
        item.addEventListener('click', () => { map.panTo(pos); map.setZoom(15); openInfo(place, leg); });
        list.appendChild(item);
      });

      if (!results.length) {
        list.innerHTML = `<div style="padding:10px;color:#666;">
          ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆã®å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åŠå¾„ã‚’åºƒã’ã‚‹ã‹ã€ã‚«ãƒ†ã‚´ãƒªã‚’å¢—ã‚„ã™ã‹ã€ã€Œå–¶æ¥­ä¸­ã®ã¿ã€ã‚’å¤–ã—ã¦å†æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚
        </div>`;
      }
    }
  </script>
</body>
</html>

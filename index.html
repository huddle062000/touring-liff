<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ライドツーリングツール（LINE × Google Maps）</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: sans-serif; }
    header { padding: 10px 16px; background: #06c755; color: white; }
    h1 { font-size: 18px; margin: 0; }

    #map { width: 100%; height: 50vh; }
    @media (min-width: 769px){ #map { height: 60vh; } }

    .panel { padding: 12px 16px; background:#fff; }
    input, select { padding: 8px; width: 100%; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 6px; }
    button { padding: 10px; font-size: 16px; border: none; border-radius: 8px; background: #06c755; color: white; width: 100%; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: default; }
    label.chk { display:flex; gap:6px; align-items:center; margin-right:12px; }

    body.fullmap header, body.fullmap #controls { display: none; }
    body.fullmap #map { height: 100vh !important; }

    #back { position: fixed; top: 10px; left: 10px; z-index: 1000; background: #06c755; color: #fff; border: none; border-radius: 8px; padding: 8px 12px; display: none; }
    body.fullmap #back { display: inline-block; }

    #fab {
      position: fixed; right: 12px; bottom: 16px; z-index: 1001;
      gap: 8px; display: none; flex-direction: column; align-items: end;
    }
    #fab button {
      padding: 10px 14px; border: none; border-radius: 20px; background: #06c755; color: #fff;
      font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,.2); white-space: nowrap; width: auto; cursor: pointer;
    }
    body.fullmap #fab { display: flex; }

    #jumpCtl { position: fixed; right: 12px; bottom: 16px; z-index: 1000;
      padding: 10px 14px; border: none; border-radius: 20px; background: #06c755; color:#fff; font-size: 14px; box-shadow:0 2px 8px rgba(0,0,0,.2); }
    body.fullmap #jumpCtl { display:none; }

    /* 休憩スポット ドロワー */
    #stopsDrawer {
      position: fixed; right: 12px; top: 12px; z-index: 1001;
      background: rgba(255,255,255,0.98); border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.2);
      width: min(360px, 92vw); max-height: 72vh; display: none; flex-direction: column;
    }
    #stopsDrawer header { display:flex; justify-content: space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #eee; }
    #stopsList { overflow:auto; max-height: 54vh; padding: 8px 10px; }
    .stopItem { border: 1px solid #eee; border-radius: 10px; padding: 8px 10px; margin-bottom: 8px; cursor: pointer; }
    .stopItem:hover { background: #fafafa; }
    .meta { color:#666; font-size:12px; display:flex; gap:8px; flex-wrap:wrap; }
    .controls { padding:10px 12px; display:flex; gap:10px; align-items:center; border-bottom:1px solid #eee; flex-wrap:wrap; }
    .controls .group { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .badge { background:#06c755; color:#fff; border-radius:12px; padding:2px 8px; font-size:12px; }

    /* 簡易エラーバナー */
    #errBanner {
      position: fixed; left: 12px; top: 12px; z-index: 2000;
      background: #ffefef; color:#900; border:1px solid #f5b5b5; padding:8px 12px; border-radius:8px; display:none;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
    }

    /* ▼ RainViewer 操作用ミニパネル（マップ上に重ねる） ▼ */
    #rvCtl {
      position: fixed; left: 12px; bottom: 12px; z-index: 1002;
      background: rgba(255,255,255,0.96); border:1px solid #eee; border-radius: 12px;
      box-shadow: 0 4px 14px rgba(0,0,0,.2); padding: 10px 12px; display: none; min-width: 220px;
      font-size: 13px; color:#333;
    }
    #rvCtl header { font-weight:700; margin-bottom:6px; display:flex; align-items:center; gap:8px; }
    #rvCtl .row { display:flex; gap:8px; align-items:center; margin-top:6px; flex-wrap:wrap; }
    #rvCtl button.small { background:#06c755; padding:6px 10px; border-radius: 8px; font-size:13px; }
    #rvCtl input[type="range"] { width: 120px; }
    #rvCtl .stamp { color:#666; font-size:12px; }

    /* fullmapでも表示 */
    body.fullmap #rvCtl { display:block; }
  </style>
</head>
<body>
  <header><h1>ライドツーリングツール</h1></header>

  <div id="errBanner"></div>

  <button id="jumpCtl" type="button">操作パネル</button>
  <div id="map"></div>

  <!-- 上：操作パネル -->
  <div id="controls" class="panel">
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="start" placeholder="出発地を入力（例：京都駅）" style="flex:1">
      <button type="button" id="btn-loc" style="width:auto; white-space:nowrap;">現在地</button>
    </div>
    <input id="end" placeholder="目的地を入力（例：美山 かやぶきの里）">
    <div style="display:flex; gap:12px; align-items:center; margin:6px 0 10px; flex-wrap:wrap;">
      <label class="chk"><input type="checkbox" id="opt-avoid-highways"> 高速を使わない</label>
      <label class="chk"><input type="checkbox" id="opt-avoid-tolls"> 有料道路を使わない</label>
    </div>
    <button id="makeRoute">ルートを作る</button>
    <button id="shareBtn" disabled>LINEで共有</button>
    <button id="navBtn" disabled>Googleナビで開く</button>
    <button id="stopsBtn" disabled>休憩スポット提案</button>
    <!-- ▼ 雨雲：ON/OFFボタン（通常画面） -->
    <button id="rainToggleBtn" type="button">雨雲（マップに重ねる）</button>
  </div>

  <!-- 下：サマリー（距離・時間のみ） -->
  <div id="summaryPanel" class="panel" style="padding-top:8px">
    <div id="summary" style="font-size:14px;line-height:1.6;color:#333">距離と時間はここに表示されます。</div>
  </div>

  <!-- 全画面時の操作 -->
  <button id="back" type="button">戻る</button>
  <div id="fab">
    <button id="navBtnFab" disabled>Googleナビ開始</button>
    <button id="shareBtnFab" disabled>LINEで共有</button>
    <button id="stopsBtnFab" disabled>休憩スポット提案</button>
    <!-- ▼ 雨雲：ON/OFF（全画面FAB） -->
    <button id="rainToggleBtnFab" type="button

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ライドツーリングツール（LINE × Google Maps）</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
    }

    header { padding: 10px 16px; background: #06c755; color: white; }
    h1 { font-size: 18px; margin: 0; }

    /* 地図はページ下部手前に、下にアクションパネルを置く */
    #map { width: 100%; flex-grow: 1; height: 50vh; }
    @media (min-width: 769px){ #map { height: 60vh; } }

    .panel { padding: 12px 16px; background:#fff; }
    input, select {
      padding: 8px; width: 100%; margin-bottom: 8px;
      border: 1px solid #ccc; border-radius: 6px;
    }
    button {
      padding: 10px; font-size: 16px; border: none; border-radius: 8px;
      background: #06c755; color: white; width: 100%; cursor: pointer;
    }
    button:disabled { opacity: .5; cursor: default; }

    label.chk { display:flex; align-items:center; gap:6px; white-space: nowrap; }

    /* チェック2つは常に横並び */
    .route-options {
      display:flex; gap:16px; flex-wrap: nowrap; margin: 6px 0 10px; overflow-x:auto;
    }

    /* エラーバナー */
    #errBanner {
      position: fixed; left: 12px; top: 12px; z-index: 2000;
      background:#ffefef; color:#900; border:1px solid #f5b5b5;
      padding:8px 12px; border-radius:8px; display:none; box-shadow:0 2px 8px rgba(0,0,0,.15);
    }

    /* 雨雲コントローラ（地図上 左下） */
    #rvCtl {
      position: fixed; left: 12px; bottom: 12px; z-index: 1002;
      background: rgba(255,255,255,0.96); border:1px solid #eee; border-radius: 12px;
      box-shadow: 0 4px 14px rgba(0,0,0,.2); padding: 10px 12px; display: none; min-width: 220px;
      font-size: 13px; color:#333;
    }
    #rvCtl header { font-weight:700; margin-bottom:6px; display:flex; align-items:center; gap:8px; }
    #rvCtl .row { display:flex; gap:8px; align-items:center; margin-top:6px; flex-wrap:wrap; }
    #rvCtl button.small { background:#06c755; padding:6px 10px; border-radius: 8px; font-size:13px; }
    #rvCtl input[type="range"] { width: 120px; }
    #rvCtl .stamp { color:#666; font-size:12px; }
  </style>
</head>
<body>
  <header><h1>ライドツーリングツール</h1></header>
  <div id="errBanner"></div>

  <!-- 上：操作パネル（検索系だけ） -->
  <div id="controls" class="panel">
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="start" placeholder="出発地を入力（例：京都駅）" style="flex:1">
      <button type="button" id="btn-loc" style="width:auto; white-space:nowrap;">現在地</button>
    </div>
    <input id="end" placeholder="目的地を入力（例：美山 かやぶきの里）">

    <div class="route-options">
      <label class="chk"><input type="checkbox" id="opt-avoid-highways"> 高速を使わない</label>
      <label class="chk"><input type="checkbox" id="opt-avoid-tolls"> 有料道路を使わない</label>
    </div>

    <button id="makeRoute">ルートを作る</button>
  </div>

  <!-- 中：地図 -->
  <div id="map"></div>

  <!-- 下：アクション（ご要望の3ボタンをここに移動） -->
  <div id="actions" class="panel" style="position:relative; z-index:0;">
    <div style="display:grid; grid-template-columns:1fr; gap:8px;">
      <button id="shareBtn" disabled>LINEで共有</button>
      <button id="navBtn" disabled>Googleナビで開く</button>
      <button id="rainToggleBtn" type="button">雨雲レーダー</button>
    </div>
  </div>

  <!-- 雨雲コントローラ -->
  <div id="rvCtl">
    <header>雨雲レーダー <span class="stamp" id="rvStamp">--:--</span></header>
    <div class="row">
      <button id="rvPlay" class="small">▶︎ 再生</button>
      <button id="rvPrev" class="small">◀︎</button>
      <button id="rvNext" class="small">▶︎</button>
      <button id="rvOff"  class="small" style="background:#999">OFF</button>
    </div>
    <div class="row">
      透明度 <input id="rvOpacity" type="range" min="20" max="100" value="60">
      <span id="rvOpacityVal">60%</span>
    </div>
  </div>

  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlN9ik-Y3CpEy3Uw9hXfBq0m2AoZWx_oM&libraries=places&language=ja&region=JP&callback=initMap" async defer></script>

  <script>
    let map, directionsService, directionsRenderer, geocoder;
    let lastRouteResult = null;

    // RainViewer
    let radarTimestamps = [], radarIndex = 0, radarTimer = null, radarLayer = null, radarOpacity = 0.6;

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 35.0116, lng: 135.7681 }, zoom: 8
      });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map });
      geocoder = new google.maps.Geocoder();
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('makeRoute').addEventListener('click', makeRoute);
      document.getElementById('shareBtn').addEventListener('click', shareOnLINE);
      document.getElementById('navBtn').addEventListener('click', openNavigation);
      document.getElementById('btn-loc').addEventListener('click', fillWithCurrentLocation);

      // 雨雲レーダー操作
      document.getElementById('rainToggleBtn').addEventListener('click', toggleRadar);
      document.getElementById('rvPlay').addEventListener('click', (e)=>togglePlay(e.currentTarget));
      document.getElementById('rvPrev').addEventListener('click', ()=>stepFrame(-1));
      document.getElementById('rvNext').addEventListener('click', ()=>stepFrame(1));
      document.getElementById('rvOff').addEventListener('click', turnRadarOff);
      document.getElementById('rvOpacity').addEventListener('input',(e)=>{
        const v=Number(e.target.value);
        document.getElementById('rvOpacityVal').textContent=v+'%';
        radarOpacity=v/100; 
        if(radarLayer) rebuildCurrentRadarLayer();
      });
    });

    // 現在地→出発地に代入
    function fillWithCurrentLocation() {
      if (!navigator.geolocation) { alert('この端末では位置情報が使えません'); return; }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude, lng = pos.coords.longitude, loc = { lat, lng };
          map.setCenter(loc); map.setZoom(12);
          geocoder.geocode({ location: loc }, (results, status) => {
            document.getElementById('start').value =
              (status === 'OK' && results && results[0]) ? results[0].formatted_address : `${lat.toFixed(6)},${lng.toFixed(6)}`;
          });
        },
        () => alert('位置情報を取得できませんでした')
      );
    }

    // ルート作成
    function makeRoute() {
      const start = document.getElementById('start').value;
      const end   = document.getElementById('end').value;
      if (!start || !end) { alert('出発地と目的地を入力してください'); return; }

      const avoidHighways = document.getElementById('opt-avoid-highways').checked;
      const avoidTolls    = document.getElementById('opt-avoid-tolls').checked;
      const req = { origin: start, destination: end, travelMode: google.maps.TravelMode.DRIVING, avoidHighways, avoidTolls };

      directionsService.route(req, (result, status) => {
        if (status === 'OK') {
          lastRouteResult = result;
          directionsRenderer.setDirections(result);

          const leg = result.routes[0].legs[0];
          const avoidParams = [];
          if (avoidHighways) avoidParams.push('highways');
          if (avoidTolls)    avoidParams.push('tolls');
          const avoidStr = avoidParams.length ? `&avoid=${avoidParams.join('%7C')}` : '';
          const gmapsUrl   =
            'https://www.google.com/maps/dir/?api=1'
            + `&origin=${encodeURIComponent(leg.start_address)}`
            + `&destination=${encodeURIComponent(leg.end_address)}`
            + `&travelmode=driving${avoidStr}`;
          const gmapsNavUrl = `${gmapsUrl}&dir_action=navigate`;

          window._sharePayload = {
            text:`出発地: ${leg.start_address}\n目的地: ${leg.end_address}\n距離: ${leg.distance.text}\n時間: ${leg.duration.text}\n\nルートを見る: ${gmapsUrl}`,
            gmapsUrl, gmapsNavUrl
          };
          document.getElementById('shareBtn').disabled = false;
          document.getElementById('navBtn').disabled = false;

          alert(`距離: ${leg.distance.text}\n時間: ${leg.duration.text}`);
        } else {
          alert('ルートを作れませんでした');
        }
      });
    }

    // Googleナビ/共有
    function openNavigation() {
      if (!window._sharePayload) { alert('先にルートを作成してください'); return; }
      window.open(window._sharePayload.gmapsUrl, '_blank');
    }
    async function shareOnLINE() {
      const payload = window._sharePayload;
      if (!payload) { alert('先にルートを作成してください'); return; }
      const shareUrl = 'https://line.me/R/share?text=' + encodeURIComponent(payload.text);
      window.open(shareUrl, '_blank');
    }

    /* ======================= 雨雲レーダー（RainViewer） ======================= */
    async function toggleRadar() {
      const ctl=document.getElementById('rvCtl');
      if(radarLayer){ turnRadarOff(); return; }

      try {
        const res=await fetch('https://api.rainviewer.com/public/weather-maps.json');
        const data=await res.json();
        radarTimestamps=[...(data?.radar?.past||[]).map(f=>f.time),...(data?.radar?.nowcast||[]).map(f=>f.time)];
        if(!radarTimestamps.length){ alert('雨雲データ取得失敗'); return; }
        radarIndex=radarTimestamps.length-1;
        fadeToFrame(radarIndex,true);
        ctl.style.display='block';
      } catch(e){ alert('雨雲データ取得エラー'); console.error(e); }
    }

    function turnRadarOff() {
      stopAnimation();
      map.overlayMapTypes.clear();
      radarLayer=null;
      document.getElementById('rvCtl').style.display='none';
    }

    function tileUrl(ts) { return `https://tilecache.rainviewer.com/v2/radar/${ts}/256/{z}/{x}/{y}/2/1_1.png`; }
    function buildLayer(ts,opacity) {
      const t=tileUrl(ts);
      return new google.maps.ImageMapType({
        getTileUrl:(coord,zoom)=>{
          const n=1<<zoom; let x=coord.x%n; if(x<0)x+=n;
          return t.replace('{z}',zoom).replace('{x}',x).replace('{y}',coord.y);
        },
        tileSize:new google.maps.Size(256,256),
        opacity:opacity
      });
    }

    // フェードで滑らかに切替
    function fadeToFrame(i,instant=false){
      if(!radarTimestamps.length) return;
      const ts=radarTimestamps[i];
      const newLayer=buildLayer(ts,0);
      map.overlayMapTypes.insertAt(0,newLayer);

      const d=new Date(ts*1000);
      document.getElementById('rvStamp').textContent=
        d.toLocaleString('ja-JP',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});

      const oldLayer=radarLayer;
      radarLayer=newLayer;

      if(instant){ radarLayer.setOpacity(radarOpacity); if(oldLayer) map.overlayMapTypes.removeAt(1); return; }

      let alpha=0;
      const fadeTimer=setInterval(()=>{
        alpha+=0.1;
        radarLayer.setOpacity(radarOpacity*alpha);
        if(oldLayer) oldLayer.setOpacity(radarOpacity*(1-alpha));
        if(alpha>=1){
          clearInterval(fadeTimer);
          radarLayer.setOpacity(radarOpacity);
          if(oldLayer){
            const arr=map.overlayMapTypes.getArray();
            const idx=arr.indexOf(oldLayer);
            if(idx>=0) map.overlayMapTypes.removeAt(idx);
          }
        }
      },50); // 約20fps
    }

    function rebuildCurrentRadarLayer(){ if(radarLayer) fadeToFrame(radarIndex,true); }
    function stepFrame(dir){
      if(!radarTimestamps.length) return;
      radarIndex=(radarIndex+dir+radarTimestamps.length)%radarTimestamps.length;
      fadeToFrame(radarIndex);
    }
    function togglePlay(btn){
      if(radarTimer){ clearInterval(radarTimer); radarTimer=null; btn.textContent='▶︎ 再生'; return; }
      btn.textContent='⏸ 一時停止';
      radarTimer=setInterval(()=>stepFrame(1),400);
    }
    function stopAnimation(){
      if(radarTimer){ clearInterval(radarTimer); radarTimer=null; }
      const btn=document.getElementById('rvPlay');
      if(btn) btn.textContent='▶︎ 再生';
    }
  </script>
</body>
</html>

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ライドツーリングツール（LINE × Google Maps）</title>
  <style>
    /* 画面いっぱいマップ */
    html, body { height: 100dvh; margin: 0; font-family: sans-serif; }
    #map { width: 100%; height: 100dvh; }

    /* 右下の丸いメインボタン（FAB） */
    #fabMain {
      position: fixed; right: 16px; bottom: 20px;
      width: 56px; height: 56px; border-radius: 50%;
      background: #06c755; color:#fff; font-size: 26px;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 3px 10px rgba(0,0,0,.3); cursor:pointer; z-index:1100;
      transition: transform .2s;
    }
    #fabMain:hover { transform: scale(1.06); }

    /* 右から出るスライドパネル */
    #sidePanel {
      position: fixed; top: 0; right: -310px; /* 初期は隠す */
      width: 300px; height: 100%;
      background: rgba(255,255,255,0.97);
      box-shadow: -2px 0 10px rgba(0,0,0,.25);
      padding: 14px; display:flex; flex-direction:column; gap:10px;
      transition: right .28s ease; z-index:1099;
    }
    #sidePanel.open { right: 0; }

    #sidePanel h2 { font-size:16px; margin:2px 0 6px; color:#06c755; }

    .row { display:flex; gap:8px; align-items:center; }
    .row input { flex:1; padding:10px; border:1px solid #ccc; border-radius:8px; }
    .btn, .btn-secondary {
      width:100%; padding:12px; border:none; border-radius:10px; font-size:15px; cursor:pointer;
    }
    .btn { background:#06c755; color:#fff; }
    .btn:disabled { opacity:.5; cursor:default; }
    .btn-secondary { background:#999; color:#fff; }

    .switches { display:flex; gap:12px; }
    .switches label { display:flex; align-items:center; gap:6px; white-space:nowrap; }

    /* 画面外タップ用の半透明オーバーレイ */
    #overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.35);
      display:none; z-index:1098;
    }
    #overlay.show { display:block; }
  </style>
</head>
<body>

  <!-- 地図 -->
  <div id="map"></div>

  <!-- 右下の丸いメニュー起動ボタン -->
  <div id="fabMain">☰</div>

  <!-- スライドパネル（FABメニューの中身） -->
  <div id="sidePanel">
    <h2>ライドメニュー</h2>

    <div class="row">
      <input id="start" placeholder="出発地を入力（例：京都駅）">
      <button id="btn-loc" class="btn" style="width:auto; padding:10px 12px;">現在地</button>
    </div>

    <input id="end" placeholder="目的地を入力（例：美山 かやぶきの里）">

    <div class="switches">
      <label><input type="checkbox" id="use-highways"> 高速使う</label>
      <label><input type="checkbox" id="use-tolls"> 有料道路使う</label>
    </div>

    <button id="makeRoute" class="btn">ルート作成</button>

    <hr style="border:none; border-top:1px solid #eee; margin:6px 0;">

    <button id="shareBtn" class="btn" disabled>LINEで共有</button>
    <button id="navBtn" class="btn" disabled>Googleナビで開く</button>
    <button id="rainToggleBtn" class="btn">雨雲レーダー</button>

    <button id="closePanel" class="btn-secondary">閉じる</button>
  </div>

  <div id="overlay"></div>

  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlN9ik-Y3CpEy3Uw9hXfBq0m2AoZWx_oM&libraries=places&language=ja&region=JP&callback=initMap" async defer></script>

  <script>
    let map, directionsService, directionsRenderer, geocoder;
    let lastLeg = null;        // 共有・ナビ用
    let radarLayer = null;     // 雨雲レイヤー
    let radarOpacity = 0.6;

    function initMap(){
      map = new google.maps.Map(document.getElementById('map'), {
        center:{lat:35.0116,lng:135.7681}, zoom: 9
      });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map });
      geocoder = new google.maps.Geocoder();
    }

    document.addEventListener('DOMContentLoaded',()=>{
      // パネル開閉
      const fab = document.getElementById('fabMain');
      const panel = document.getElementById('sidePanel');
      const overlay = document.getElementById('overlay');
      const closeBtn = document.getElementById('closePanel');

      function openPanel(){ panel.classList.add('open'); overlay.classList.add('show'); }
      function closePanel(){ panel.classList.remove('open'); overlay.classList.remove('show'); }

      fab.addEventListener('click', openPanel);
      overlay.addEventListener('click', closePanel);
      closeBtn.addEventListener('click', closePanel);

      // 入力系
      document.getElementById('btn-loc').addEventListener('click', fillWithCurrentLocation);
      document.getElementById('makeRoute').addEventListener('click', makeRoute);

      // アクション
      document.getElementById('shareBtn').addEventListener('click', shareOnLINE);
      document.getElementById('navBtn').addEventListener('click', openNavigation);
      document.getElementById('rainToggleBtn').addEventListener('click', toggleRadarLatest);
    });

    // 現在地→出発地
    function fillWithCurrentLocation(){
      if (!navigator.geolocation){ alert('位置情報が使えません'); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        map.setCenter(loc); map.setZoom(12);
        geocoder.geocode({ location: loc }, (results, status) => {
          document.getElementById('start').value =
            (status==='OK' && results && results[0]) ? results[0].formatted_address : `${loc.lat},${loc.lng}`;
        });
      }, ()=>alert('現在地を取得できませんでした'));
    }

    // ルート作成
    function makeRoute(){
      const start = document.getElementById('start').value.trim();
      const end   = document.getElementById('end').value.trim();
      if(!start || !end){ alert('出発地と目的地を入力してください'); return; }

      // 「使う」→ avoid=false
      const useHighways = document.getElementById('use-highways').checked;
      const useTolls    = document.getElementById('use-tolls').checked;
      const req = {
        origin: start, destination: end, travelMode: google.maps.TravelMode.DRIVING,
        avoidHighways: !useHighways, avoidTolls: !useTolls
      };

      directionsService.route(req, (result, status)=>{
        if(status === 'OK'){
          directionsRenderer.setDirections(result);
          lastLeg = result.routes[0].legs[0];

          // 共有用テキスト作成
          const avoidParams = [];
          if (!useHighways) avoidParams.push('highways');
          if (!useTolls)    avoidParams.push('tolls');
          const avoidStr = avoidParams.length ? `&avoid=${avoidParams.join('%7C')}` : '';

          const gmapsUrl =
            'https://www.google.com/maps/dir/?api=1'
            + `&origin=${encodeURIComponent(lastLeg.start_address)}`
            + `&destination=${encodeURIComponent(lastLeg.end_address)}`
            + `&travelmode=driving${avoidStr}`;
          const gmapsNavUrl = `${gmapsUrl}&dir_action=navigate`;

          window._sharePayload = {
            text:
`出発地: ${lastLeg.start_address}
目的地: ${lastLeg.end_address}
距離: ${lastLeg.distance.text}
時間: ${lastLeg.duration.text}
設定: 高速=${useHighways?'使う':'使わない'} / 有料=${useTolls?'使う':'使わない'}

ルートを見る: ${gmapsUrl}`,
            gmapsUrl, gmapsNavUrl
          };

          document.getElementById('shareBtn').disabled = false;
          document.getElementById('navBtn').disabled = false;
        } else {
          alert('ルートを作れませんでした（' + status + '）');
        }
      });
    }

    // LINE共有
    function shareOnLINE(){
      const p = window._sharePayload;
      if(!p){ alert('先にルートを作成してください'); return; }
      const shareUrl = 'https://line.me/R/share?text=' + encodeURIComponent(p.text);
      window.open(shareUrl, '_blank');
    }

    // Googleナビを開く（PCは地図URL、スマホはナビ）
    function openNavigation(){
      const p = window._sharePayload;
      if(!p){ alert('先にルートを作成してください'); return; }
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      window.open(isMobile ? p.gmapsNavUrl : p.gmapsUrl, '_blank');
      if(!isMobile) setTimeout(()=>alert('PCブラウザでは音声ナビは使えません。ブラウザで経路を開きました。'), 250);
    }

    /* ===== 雨雲レーダー（最新フレームのON/OFFだけ簡易実装） ===== */
    async function toggleRadarLatest(){
      if(radarLayer){
        const idx = map.overlayMapTypes.getArray().indexOf(radarLayer);
        if(idx>=0) map.overlayMapTypes.removeAt(idx);
        radarLayer = null;
        return;
      }
      try{
        const res = await fetch('https://api.rainviewer.com/public/weather-maps.json');
        const data = await res.json();
        const all = [...(data?.radar?.past||[]), ...(data?.radar?.nowcast||[])];
        if(!all.length) return alert('雨雲データを取得できませんでした');

        const ts = all[all.length-1].time; // 最新
        const tUrl = `https://tilecache.rainviewer.com/v2/radar/${ts}/256/{z}/{x}/{y}/2/1_1.png`;
        radarLayer = new google.maps.ImageMapType({
          getTileUrl:(coord,zoom)=>{
            const n=1<<zoom; let x=coord.x%n; if(x<0)x+=n;
            return tUrl.replace('{z}',zoom).replace('{x}',x).replace('{y}',coord.y);
          },
          tileSize:new google.maps.Size(256,256),
          opacity:radarOpacity
        });
        map.overlayMapTypes.insertAt(0, radarLayer);
      }catch(e){
        alert('雨雲データ取得エラー'); console.error(e);
      }
    }
  </script>
</body>
</html>

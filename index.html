<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ©ã‚¤ãƒ‰ãƒ„ãƒ¼ãƒªãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ï¼ˆLINE Ã— Google Mapsï¼‰</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: sans-serif; }
    header { padding: 10px 16px; background: #06c755; color: white; }
    h1 { font-size: 18px; margin: 0; }
    #map { width: 100%; height: 60vh; }
    .panel { padding: 12px 16px; }
    input, select { padding: 8px; width: 100%; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 6px; }
    button { padding: 10px; font-size: 16px; border: none; border-radius: 8px; background: #06c755; color: white; width: 100%; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: default; }
    label.chk { display:flex; gap:6px; align-items:center; margin-right:12px; }

    /* å…¨ç”»é¢è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    body.fullmap header,
    body.fullmap .panel { display: none; }
    body.fullmap #map { height: 100vh !important; }

    #back { 
      position: fixed; top: 10px; left: 10px; z-index: 1000;
      background: #06c755; color: #fff; border: none; border-radius: 8px;
      padding: 8px 12px; display: none;
    }
    body.fullmap #back { display: inline-block; }

    /* å…¨ç”»é¢æ™‚ã«å‡ºã™ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ“ä½œãƒœã‚¿ãƒ³ */
    #fab {
      position: fixed;
      right: 12px;
      bottom: 16px;
      display: none;
      z-index: 1001;
      gap: 8px;
      flex-direction: column;
      align-items: end;
    }
    #fab button, #fab .pill {
      padding: 10px 14px;
      border: none;
      border-radius: 20px;
      background: #06c755;
      color: #fff;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,.2);
      white-space: nowrap;
      width: auto;
      cursor: pointer;
    }
    body.fullmap #fab { display: flex; }

    /* å¤©æ°—ãƒãƒƒã‚¸ */
    #weatherBadge {
      position: fixed; left: 12px; bottom: 16px; z-index: 1001;
      background: rgba(255,255,255,0.92); color: #222; border-radius: 12px;
      padding: 8px 12px; font-size: 13px; line-height: 1.4; box-shadow: 0 2px 8px rgba(0,0,0,.15);
      display: none; min-width: 180px;
    }
    #weatherBadge .title{ font-weight:700; font-size:12px; color:#06c755; }
    #weatherBadge .row{ display:flex; gap:8px; flex-wrap:wrap; }

    /* ãƒ¬ãƒ¼ãƒ€ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
    #radarCtl {
      display: flex; gap: 8px; align-items: center;
      background: rgba(0,0,0,0.65);
      color: #fff; padding: 8px 10px; border-radius: 12px;
    }
    #radarCtl input[type="range"]{ width: 140px; }

    /* ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆ ãƒ‰ãƒ­ãƒ¯ãƒ¼ */
    #stopsDrawer {
      position: fixed; right: 12px; top: 12px; z-index: 1001;
      background: rgba(255,255,255,0.98); border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.2);
      width: min(360px, 92vw); max-height: 70vh; display: none; flex-direction: column;
    }
    #stopsDrawer header { display:flex; justify-content: space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #eee; }
    #stopsList { overflow:auto; max-height: 52vh; padding: 8px 10px; }
    .stopItem {
      border: 1px solid #eee; border-radius: 10px; padding: 8px 10px; margin-bottom: 8px; cursor: pointer;
    }
    .stopItem:hover { background: #fafafa; }
    .meta { color:#666; font-size:12px; display:flex; gap:8px; flex-wrap:wrap; }
    .controls { padding:10px 12px; display:flex; gap:10px; align-items:center; border-bottom:1px solid #eee; flex-wrap:wrap; }
    .controls .group { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .badge { background:#06c755; color:#fff; border-radius:12px; padding:2px 8px; font-size:12px; }

  </style>
</head>
<body>
  <header><h1>ãƒ©ã‚¤ãƒ‰ãƒ„ãƒ¼ãƒªãƒ³ã‚°ãƒ„ãƒ¼ãƒ«</h1></header>

  <!-- å…¨ç”»é¢æ™‚ã®ã¿è¦‹ãˆã‚‹æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
  <button id="back" type="button">æˆ»ã‚‹</button>

  <!-- å…¨ç”»é¢æ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ“ä½œ -->
  <div id="fab">
    <div id="radarCtl" style="display:none;">
      <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
        <input type="checkbox" id="radarToggle" />
        é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼
      </label>
      <label style="display:flex;align-items:center;gap:6px;">
        é€æ˜åº¦
        <input type="range" id="radarOpacity" min="0" max="100" value="70" />
      </label>
    </div>
    <button id="stopsBtnFab" disabled>ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆææ¡ˆ</button>
    <button id="navBtnFab" disabled>GoogleãƒŠãƒ“é–‹å§‹</button>
    <button id="shareBtnFab" disabled>LINEã§å…±æœ‰</button>
  </div>

  <!-- å·¦ä¸‹ã®å¤©æ°—ãƒãƒƒã‚¸ -->
  <div id="weatherBadge">
    <div class="title">ç¾åœ¨ã®å¤©æ°—</div>
    <div class="row">
      <div id="wb-location">-</div>
      <div id="wb-temp">-â„ƒ</div>
      <div id="wb-rain">é™æ°´ - mm</div>
      <div id="wb-wind">é¢¨ - m/s</div>
    </div>
    <div style="font-size:11px;color:#666;">5ã€œ10åˆ†ã”ã¨ã«æ›´æ–°</div>
  </div>

  <!-- ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆ ãƒ‰ãƒ­ãƒ¯ãƒ¼ -->
  <div id="stopsDrawer">
    <header>
      <div>ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆå€™è£œ <span id="stopsCount" class="badge">0ä»¶</span></div>
      <button id="stopsClose" style="width:auto;background:#999;">é–‰ã˜ã‚‹</button>
    </header>
    <div class="controls">
      <div class="group">
        <label class="chk"><input type="checkbox" class="stop-type" value="é“ã®é§…" checked>é“ã®é§…</label>
        <label class="chk"><input type="checkbox" class="stop-type" value="cafe" checked>ã‚«ãƒ•ã‚§</label>
        <label class="chk"><input type="checkbox" class="stop-type" value="gas_station" checked>GS</label>
        <label class="chk"><input type="checkbox" class="stop-type" value="parking" checked>é§è»Šå ´</label>
        <label class="chk"><input type="checkbox" class="stop-type" value="tourist_attraction">è¦³å…‰</label>
      </div>
      <div class="group">
        åŠå¾„
        <select id="stopRadius" style="width:auto;">
          <option value="2000">2km</option>
          <option value="3000" selected>3km</option>
          <option value="5000">5km</option>
          <option value="8000">8km</option>
        </select>
        <label class="chk"><input type="checkbox" id="onlyOpen">å–¶æ¥­ä¸­ã®ã¿</label>
      </div>
      <button id="stopsRefresh" style="width:auto;">å†æ¤œç´¢</button>
    </div>
    <div id="stopsList"></div>
  </div>

  <div class="panel">
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="start" placeholder="å‡ºç™ºåœ°ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šäº¬éƒ½é§…ï¼‰" style="flex:1">
      <button type="button" id="btn-loc" style="width:auto; white-space:nowrap;">ç¾åœ¨åœ°</button>
    </div>

    <input id="end" placeholder="ç›®çš„åœ°ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šç¾å±± ã‹ã‚„ã¶ãã®é‡Œï¼‰">

    <div style="display:flex; gap:12px; align-items:center; margin:6px 0 10px">
      <label class="chk">
        <input type="checkbox" id="opt-avoid-highways">
        é«˜é€Ÿã‚’ä½¿ã‚ãªã„
      </label>
      <label class="chk">
        <input type="checkbox" id="opt-avoid-tolls">
        æœ‰æ–™é“è·¯ã‚’ä½¿ã‚ãªã„
      </label>
    </div>

    <button id="makeRoute">ãƒ«ãƒ¼ãƒˆã‚’ä½œã‚‹</button>
    <button id="shareBtn" disabled>LINEã§å…±æœ‰</button>
    <button id="navBtn" disabled>GoogleãƒŠãƒ“ã§é–‹ã</button>

    <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
      <label class="chk">
        <input type="checkbox" id="radarTogglePanel" /> é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼è¡¨ç¤º
      </label>
      <button id="stopsBtn" disabled style="width:auto;">ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆææ¡ˆ</button>
    </div>
  </div>

  <div id="map"></div>

  <div class="panel" style="padding-top:8px">
    <div id="summary" style="font-size:14px;line-height:1.6;color:#333"></div>
  </div>

  <!-- LINE SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = "2008438848-3gJlGQvy";
    (async function initLIFFSafe() {
      try { if (window.liff) { await liff.init({ liffId: LIFF_ID }); } }
      catch (e) { console.warn('LIFF init skipped:', e); }
    })();
  </script>

  <!-- Google Maps APIï¼ˆPlaceså«ã‚€ï¼‰ -->
  <script>
    let map, directionsService, directionsRenderer;
    let geocoder, currentMarker, placesService, infoWnd;
    let lastRouteResult = null;

    /* å¤©æ°—é–¢é€£ */
    let weatherTimer = null;

    /* é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ï¼ˆRainViewerï¼‰ */
    let radarLayer = null, radarTimestamp = null, radarTimer = null;
    const RADAR_UPDATE_MS = 5 * 60 * 1000;

    /* ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆ */
    let stopMarkers = [];
    const stopIcon = {
      cafe: "â˜•", gas_station: "â›½", parking: "ğŸ…¿", tourist_attraction:"ğŸ“", michi:"ğŸ¯"
    };

    /* ç«¯æœ«åˆ¤å®š */
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  </script>
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlN9ik-Y3CpEy3Uw9hXfBq0m2AoZWx_oM&libraries=places&language=ja&callback=initMap"
    async defer></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('makeRoute').addEventListener('click', makeRoute);
      document.getElementById('shareBtn').addEventListener('click', shareOnLINE);
      document.getElementById('navBtn').addEventListener('click', openNavigation);
      document.getElementById('btn-loc').addEventListener('click', fillWithCurrentLocation);

      // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å´
      document.getElementById('shareBtnFab').addEventListener('click', shareOnLINE);
      document.getElementById('navBtnFab').addEventListener('click', openNavigation);
      document.getElementById('stopsBtnFab').addEventListener('click', () => suggestStops(true));

      // ãƒ¬ãƒ¼ãƒ€ãƒ¼ON/OFFåŒæœŸ
      const syncRadar = (checked) => {
        document.getElementById('radarToggle').checked = checked;
        document.getElementById('radarTogglePanel').checked = checked;
        if (checked) { enableRadar(); } else { disableRadar(); }
      };
      document.getElementById('radarToggle').addEventListener('change', (e)=>syncRadar(e.target.checked));
      document.getElementById('radarTogglePanel').addEventListener('change', (e)=>syncRadar(e.target.checked));
      document.getElementById('radarOpacity').addEventListener('input', (e) => {
        const v = Number(e.target.value)/100;
        if (radarLayer) radarLayer.setOpacity(v);
      });

      // ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆUI
      document.getElementById('stopsBtn').addEventListener('click', () => suggestStops(true));
      document.getElementById('stopsClose').addEventListener('click', () => {
        document.getElementById('stopsDrawer').style.display = 'none';
      });
      document.getElementById('stopsRefresh').addEventListener('click', () => suggestStops(false));

      // æˆ»ã‚‹
      document.getElementById('back').addEventListener('click', () => {
        document.body.classList.remove('fullmap');
        if (window.google && map) google.maps.event.trigger(map, 'resize');
        document.getElementById('shareBtnFab').disabled = true;
        document.getElementById('navBtnFab').disabled   = true;
        document.getElementById('stopsBtnFab').disabled = true;
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), { center: { lat: 35.0116, lng: 135.7681 }, zoom: 9 });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map });
      geocoder = new google.maps.Geocoder();
      placesService = new google.maps.places.PlacesService(map);
      infoWnd = new google.maps.InfoWindow();

      // å¤©æ°—
      refreshWeatherAt(map.getCenter());
      let weatherDebounce = null;
      map.addListener('idle', () => {
        clearTimeout(weatherDebounce);
        weatherDebounce = setTimeout(()=>refreshWeatherAt(map.getCenter()), 5000);
      });

      // ãƒ¬ãƒ¼ãƒ€ãƒ¼UI
      document.getElementById('radarCtl').style.display = 'flex';
    }

    /* ç¾åœ¨åœ° */
    function fillWithCurrentLocation() {
      if (!navigator.geolocation) { alert('ã“ã®ç«¯æœ«ã§ã¯ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“'); return; }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude, lng = pos.coords.longitude, loc = { lat, lng };
          map.setCenter(loc); map.setZoom(12);
          if (currentMarker) currentMarker.setMap(null);
          currentMarker = new google.maps.Marker({ position: loc, map, title: 'ç¾åœ¨åœ°' });
          refreshWeatherAt(loc);
          geocoder.geocode({ location: loc }, (results, status) => {
            document.getElementById('start').value =
              (status === 'OK' && results && results[0]) ? results[0].formatted_address : `${lat.toFixed(6)},${lng.toFixed(6)}`;
          });
        },
        (err) => {
          const msg = {1:'ä½ç½®æƒ…å ±ã®æ¨©é™ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ',2:'ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ',3:'ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ'}[err.code] || 'ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
          alert(msg);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    /* ãƒ«ãƒ¼ãƒˆä½œæˆ */
    async function makeRoute() {
      const start = document.getElementById('start').value;
      const end   = document.getElementById('end').value;
      if (!start || !end) { alert('å‡ºç™ºåœ°ã¨ç›®çš„åœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      const avoidHighways = document.getElementById('opt-avoid-highways').checked;
      const avoidTolls    = document.getElementById('opt-avoid-tolls').checked;

      const req = {
        origin: start, destination: end, travelMode: google.maps.TravelMode.DRIVING,
        avoidHighways, avoidTolls
      };

      directionsService.route(req, (result, status) => {
        if (status === 'OK') {
          lastRouteResult = result;
          directionsRenderer.setDirections(result);
          document.body.classList.add('fullmap');
          if (window.google && map) google.maps.event.trigger(map, 'resize');

          const leg = result.routes[0].legs[0];
          const s = document.getElementById('summary');
          const optTxt = `ï¼ˆé«˜é€Ÿ: ${avoidHighways ? 'ä½¿ã‚ãªã„' : 'ä½¿ã†'} / æœ‰æ–™: ${avoidTolls ? 'ä½¿ã‚ãªã„' : 'ä½¿ã†'}ï¼‰`;
          s.textContent = `è·é›¢: ${leg.distance.text}ã€€æ™‚é–“: ${leg.duration.text} ${optTxt}`;

          const avoidParams = [];
          if (avoidHighways) avoidParams.push('highways');
          if (avoidTolls)    avoidParams.push('tolls');
          const avoidStr = avoidParams.length ? `&avoid=${avoidParams.join('%7C')}` : '';

          const gmapsUrl =
            'https://www.google.com/maps/dir/?api=1' +
            `&origin=${encodeURIComponent(leg.start_address)}` +
            `&destination=${encodeURIComponent(leg.end_address)}` +
            `&travelmode=driving${avoidStr}`;
          const gmapsNavUrl =
            'https://www.google.com/maps/dir/?api=1' +
            `&origin=${encodeURIComponent(leg.start_address)}` +
            `&destination=${encodeURIComponent(leg.end_address)}` +
            `&travelmode=driving&dir_action=navigate`;

          window._sharePayload = {
            text:
              `å‡ºç™ºåœ°: ${leg.start_address}\n` +
              `ç›®çš„åœ°: ${leg.end_address}\n` +
              `è·é›¢: ${leg.distance.text}\n` +
              `æ™‚é–“: ${leg.duration.text}\n` +
              `è¨­å®š: é«˜é€Ÿ=${avoidHighways ? 'ä½¿ã‚ãªã„' : 'ä½¿ã†'} / æœ‰æ–™=${avoidTolls ? 'ä½¿ã‚ãªã„' : 'ä½¿ã†'}\n\n` +
              `ãƒ«ãƒ¼ãƒˆã‚’è¦‹ã‚‹: ${gmapsUrl}`,
            gmapsUrl, gmapsNavUrl
          };

          // ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
          document.getElementById('shareBtn').disabled = false;
          document.getElementById('navBtn').disabled   = false;
          document.getElementById('shareBtnFab').disabled = false;
          document.getElementById('navBtnFab').disabled   = false;
          document.getElementById('stopsBtn').disabled   = false;
          document.getElementById('stopsBtnFab').disabled= false;

          // ç›®çš„åœ°ä»˜è¿‘ã®å¤©æ°—
          refreshWeatherAt(leg.end_location);

        } else {
          alert('ãƒ«ãƒ¼ãƒˆã‚’ä½œã‚Œã¾ã›ã‚“ã§ã—ãŸ');
          document.getElementById('summary').textContent = '';
        }
      });
    }

    /* ãƒŠãƒ“ */
    function openNavigation() {
      if (!window._sharePayload) { alert('å…ˆã«ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚'); return; }
      const url = isMobile ? window._sharePayload.gmapsNavUrl : window._sharePayload.gmapsUrl;
      window.open(url, '_blank');
      if (!isMobile) setTimeout(()=>alert('PCãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŸ³å£°ãƒŠãƒ“ã¯ä½¿ãˆã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§çµŒè·¯ã‚’é–‹ãã¾ã—ãŸã€‚'), 300);
    }

    /* LINEå…±æœ‰ */
    async function shareOnLINE() {
      try {
        const payload = window._sharePayload;
        if (!payload) { alert('å…ˆã«ã€Œãƒ«ãƒ¼ãƒˆã‚’ä½œã‚‹ã€ã§çµŒè·¯ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚'); return; }
        if (window.liff && liff.isInClient && liff.isInClient() && liff.isApiAvailable && liff.isApiAvailable('shareTargetPicker')) {
          try { const res = await liff.shareTargetPicker([{ type: 'text', text: payload.text }]); if (res) alert('é€ä¿¡ã—ã¾ã—ãŸï¼'); return; }
          catch (e) { console.warn('shareTargetPickerå¤±æ•—:', e); }
        }
        const shareUrl = 'https://line.me/R/share?text=' + encodeURIComponent(payload.text);
        window.open(shareUrl, '_blank');
      } catch (e) { alert('å…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸï¼š\n' + (e?.message || String(e))); }
    }

    /* å¤©æ°—ï¼ˆOpen-Meteoï¼‰ */
    async function refreshWeatherAt(latLng) {
      const lat = (typeof latLng.lat === 'function') ? latLng.lat() : latLng.lat;
      const lng = (typeof latLng.lng === 'function') ? latLng.lng() : latLng.lng;
      try {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,precipitation,wind_speed_10m&timezone=auto`;
        const res = await fetch(url); const data = await res.json(); const cur = data.current;
        document.getElementById('wb-temp').textContent = `${Math.round(cur.temperature_2m)}â„ƒ`;
        document.getElementById('wb-rain').textContent = `é™æ°´ ${cur.precipitation ?? 0} mm`;
        document.getElementById('wb-wind').textContent = `é¢¨ ${cur.wind_speed_10m ?? 0} m/s`;
        geocoder.geocode({ location: {lat, lng} }, (results, status) => {
          const name = (status === 'OK' && results && results[0])
            ? (results[0].address_components?.find(c=>c.types.includes('locality'))?.long_name || results[0].formatted_address.split('ã€')[0])
            : `(${lat.toFixed(2)},${lng.toFixed(2)})`;
          document.getElementById('wb-location').textContent = name;
        });
        document.getElementById('weatherBadge').style.display = 'block';
        if (weatherTimer) clearTimeout(weatherTimer);
        weatherTimer = setTimeout(()=>refreshWeatherAt({lat, lng}), 10*60*1000);
      } catch(e) { console.warn('å¤©æ°—å–å¾—å¤±æ•—', e); }
    }

    /* é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ON/OFF */
    async function enableRadar() {
      try {
        const metaRes = await fetch('https://api.rainviewer.com/public/weather-maps.json');
        const meta = await metaRes.json();
        const frames = meta?.radar?.past || [];
        const last = frames[frames.length - 1];
        radarTimestamp = last?.time || null;
        if (!radarTimestamp) { alert('ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ'); syncRadarUI(false); return; }
        disableRadar();
        radarLayer = new google.maps.ImageMapType({
          getTileUrl: (coord, zoom) =>
            `https://tilecache.rainviewer.com/v2/radar/${radarTimestamp}/256/${zoom}/${coord.x}/${coord.y}/2/1_1.png`,
          tileSize: new google.maps.Size(256, 256), name: 'RainViewer',
          opacity: Number(document.getElementById('radarOpacity').value)/100, isPng: true
        });
        map.overlayMapTypes.insertAt(0, radarLayer);
        if (radarTimer) clearInterval(radarTimer);
        radarTimer = setInterval(enableRadar, RADAR_UPDATE_MS);
      } catch (e) { console.warn('ãƒ¬ãƒ¼ãƒ€ãƒ¼å–å¾—å¤±æ•—', e); alert('é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    }
    function disableRadar() {
      if (radarTimer) { clearInterval(radarTimer); radarTimer = null; }
      if (map && radarLayer) {
        for (let i=map.overlayMapTypes.getLength()-1; i>=0; i--) {
          const t = map.overlayMapTypes.getAt(i);
          if (t === radarLayer) { map.overlayMapTypes.removeAt(i); }
        }
        radarLayer = null;
      }
    }
    function syncRadarUI(checked){
      document.getElementById('radarToggle').checked = checked;
      document.getElementById('radarTogglePanel').checked = checked;
    }

    /* ===== ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆ è‡ªå‹•ææ¡ˆ ===== */
    function suggestStops(openDrawerFirst = true) {
      if (!lastRouteResult) { alert('å…ˆã«ãƒ«ãƒ¼ãƒˆã‚’ä½œã£ã¦ãã ã•ã„'); return; }
      const typesChecked = [...document.querySelectorAll('.stop-type:checked')].map(el => el.value);
      if (!typesChecked.length) { alert('æ¢ã™ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
      const radius = Number(document.getElementById('stopRadius').value);
      const openNow = document.getElementById('onlyOpen').checked;

      // æ¤œç´¢åœ°ç‚¹ï¼šç›®çš„åœ° + ãƒ«ãƒ¼ãƒˆä¸­é–“ç‚¹
      const route = lastRouteResult.routes[0];
      const leg = route.legs[0];
      const endLoc = leg.end_location;
      const midLoc = getRouteMidpoint(route);

      clearStopMarkers();
      const promises = [];

      for (const t of typesChecked) {
        if (t === 'é“ã®é§…') {
          promises.push(nearbySearchKeyword(endLoc, 'é“ã®é§…', radius, openNow));
          promises.push(nearbySearchKeyword(midLoc, 'é“ã®é§…', radius, openNow));
        } else {
          promises.push(nearbySearchType(endLoc, t, radius, openNow));
          promises.push(nearbySearchType(midLoc, t, radius, openNow));
        }
      }

      Promise.all(promises).then(resultsArrays => {
        const flat = resultsArrays.flat();
        // é‡è¤‡ã‚’ place_id ã§æ’é™¤
        const seen = new Set();
        const unique = [];
        for (const r of flat) { if (!seen.has(r.place_id)) { seen.add(r.place_id); unique.push(r); } }

        // è©•ä¾¡ / ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•° / è·é›¢ã§ã‚½ãƒ¼ãƒˆ
        unique.sort((a,b) => (b.rating||0) - (a.rating||0) || (b.user_ratings_total||0)-(a.user_ratings_total||0));

        // ä¸Šä½20ä»¶ã¾ã§
        const top = unique.slice(0,20);
        renderStops(top, leg);
        if (openDrawerFirst) document.getElementById('stopsDrawer').style.display = 'flex';
      });
    }

    function renderStops(results, leg) {
      const list = document.getElementById('stopsList'); list.innerHTML = '';
      document.getElementById('stopsCount').textContent = `${results.length}ä»¶`;

      results.forEach(place => {
        // ãƒ”ãƒ³
        const pos = place.geometry.location;
        const typeKey = (place.types||[]).find(t => stopIcon[t]) ? (place.types||[]).find(t => stopIcon[t]) : (place.name.includes('é“ã®é§…') ? 'michi' : 'tourist_attraction');
        const marker = new google.maps.Marker({
          position: pos, map,
          label: { text: stopIcon[typeKey] || 'ğŸ“', color: '#000', fontSize: '16px' }
        });
        marker.addListener('click', () => openInfo(place, leg));
        stopMarkers.push(marker);

        // ãƒªã‚¹ãƒˆ
        const item = document.createElement('div');
        item.className = 'stopItem';
        const distDur = estimateDetour(leg, pos);
        item.innerHTML = `
          <div style="font-weight:700">${place.name}</div>
          <div class="meta">
            <span>${place.vicinity || place.formatted_address || ''}</span>
            <span>â˜…${place.rating || '-'}ï¼ˆ${place.user_ratings_total || 0}ä»¶ï¼‰</span>
            ${distDur ? `<span>${distDur}</span>` : ''}
            ${place.opening_hours?.open_now !== undefined ? `<span>${place.opening_hours.open_now ? 'å–¶æ¥­ä¸­' : 'å–¶æ¥­æ™‚é–“å¤–'}</span>` : ''}
          </div>
        `;
        item.addEventListener('click', () => {
          map.panTo(pos); map.setZoom(15);
          openInfo(place, leg);
        });
        list.appendChild(item);
      });

      if (!results.length) {
        list.innerHTML = `<div style="padding:10px;color:#666;">è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åŠå¾„ã‚’åºƒã’ã‚‹ã‹ã‚«ãƒ†ã‚´ãƒªã‚’å¢—ã‚„ã—ã¦å†æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚</div>`;
      }
    }

    function openInfo(place, leg){
      const pos = place.geometry.location;
      const navUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(leg.end_address)}&destination=${encodeURIComponent(place.name)}&destination_place_id=${place.place_id}&travelmode=driving`;
      const detour = estimateDetour(leg, pos) || '';
      infoWnd.setContent(`
        <div style="max-width:260px">
          <div style="font-weight:700;margin-bottom:4px">${place.name}</div>
          <div style="font-size:12px;color:#666;margin-bottom:6px">${place.vicinity || place.formatted_address || ''}</div>
          <div class="meta" style="margin-bottom:6px">
            <span>â˜…${place.rating || '-'}ï¼ˆ${place.user_ratings_total || 0}ä»¶ï¼‰</span>
            ${detour ? `<span>${detour}</span>` : ''}
            ${place.opening_hours?.open_now !== undefined ? `<span>${place.opening_hours.open_now ? 'å–¶æ¥­ä¸­' : 'å–¶æ¥­æ™‚é–“å¤–'}</span>` : ''}
          </div>
          <a href="${navUrl}" target="_blank" style="display:inline-block;background:#06c755;color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none;">ã“ã“ã¸ãƒŠãƒ“</a>
        </div>
      `);
      infoWnd.open({ map, position: pos });
    }

    function clearStopMarkers(){
      stopMarkers.forEach(m => m.setMap(null));
      stopMarkers = [];
    }

    function nearbySearchType(location, type, radius, openNow){
      return new Promise(resolve => {
        placesService.nearbySearch({
          location, radius, type, openNow
        }, (res, status) => resolve(status === 'OK' && res ? res : []));
      });
    }

    function nearbySearchKeyword(location, keyword, radius, openNow){
      return new Promise(resolve => {
        placesService.nearbySearch({
          location, radius, keyword, openNow
        }, (res, status) => resolve(status === 'OK' && res ? res : []));
      });
    }

    function getRouteMidpoint(route){
      // overview_path ã®ä¸­å¤®ç‚¹
      const path = route.overview_path || [];
      if (path.length === 0) return route.legs[0].start_location;
      return path[Math.floor(path.length/2)];
    }

    function estimateDetour(leg, pos){
      // ã–ã£ãã‚Šï¼šç›®çš„åœ°ã‹ã‚‰ã‚¹ãƒãƒƒãƒˆã¾ã§ã®ç›´ç·šè·é›¢ã‚’å‚è€ƒã«è¡¨ç¤º
      const d = google.maps.geometry ? haversine(leg.end_location, pos) : simpleApprox(leg.end_location, pos);
      if (d == null) return '';
      const km = (d/1000).toFixed(1);
      return `ç›®çš„åœ°ã‹ã‚‰ç´„${km}km`;
    }

    function haversine(a, b){
      const toRad = x => x*Math.PI/180;
      const lat1 = a.lat(), lon1 = a.lng(), lat2 = b.lat(), lon2 = b.lng();
      const R=6371000; const dLat=toRad(lat2-lat1); const dLon=toRad(lon2-lon1);
      const s1=Math.sin(dLat/2), s2=Math.sin(dLon/2);
      const c=2*Math.asin(Math.sqrt(s1*s1+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*s2*s2));
      return R*c;
    }
    function simpleApprox(a,b){
      try{ return haversine(a,b); }catch(e){ return null; }
    }
  </script>

  <!-- åˆ©ç”¨ä¸Šã®ãƒ’ãƒ³ãƒˆï¼šHTTPSå¿…é ˆï¼ˆPCã®ç¾åœ¨åœ°ï¼‰ -->
</body>
</html>

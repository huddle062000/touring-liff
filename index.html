<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ライドツーリングツール（LINE × Google Maps）</title>
  <style>
    :root{
      --navy:#1f4070;          /* トップバー色 */
      --accent:#06c755;        /* ブランドグリーン */
      --ink:#0f172a;
      --muted:#6b7280;
      --card:#ffffff;
      --shadow:0 6px 24px rgba(0,0,0,.16);
    }
    /* リセット */
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif;background:#f5f7fb;color:var(--ink)}
    #map{width:100%;height:100vh}

    /* ====== 上部ナビ（スクショ風）====== */
    .appbar{
      position:fixed;inset:0 0 auto 0;height:72px;background:var(--navy);color:#fff;z-index:1002;
      display:flex;align-items:center;justify-content:space-between;padding:0 12px 8px 12px;
      box-shadow:0 2px 18px rgba(0,0,0,.25);
      clip-path: path("M0,0 H1000 V56 Q980,72 940,72 H60 Q20,72 0,56 Z"); /* 下辺がゆるく湾曲 */
    }
    .row{display:flex;align-items:center;gap:10px}
    .iconbtn{
      width:36px;height:36px;border-radius:18px;background:rgba(255,255,255,.12);
      display:grid;place-items:center;border:none;color:#fff;cursor:pointer
    }
    .search-pill{
      flex:1;display:flex;align-items:center;gap:8px;
      background:#fff;color:#111;border-radius:24px;padding:10px 14px;box-shadow:var(--shadow);
      min-width:0
    }
    .search-pill input{
      border:none;outline:none;flex:1;font-size:15px;background:transparent;min-width:60px
    }
    .home-chip{
      border-radius:16px;padding:8px 12px;background:rgba(255,255,255,.14);backdrop-filter:blur(2px);font-size:14px
    }

    /* ====== 中央の「ルート作成」タブ ====== */
    .route-tab{
      position:fixed;left:50%;top:58px;transform:translateX(-50%);
      background:var(--navy);color:#fff;border-radius:18px 18px 24px 24px;
      padding:10px 18px;z-index:1001;box-shadow:var(--shadow);display:flex;gap:6px;align-items:center
    }
    .route-tab::after{
      /* タブ下の小さな葉アイコン風の丸ノッチ */
      content:"";position:absolute;left:50%;bottom:-8px;transform:translateX(-50%);
      width:16px;height:16px;border-radius:50%;background:#f2d28c;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.2)
    }
    .route-menu{border:none;background:transparent;color:#fff;font-weight:700;font-size:18px;cursor:pointer}

    /* ====== 左側スタック（レイヤー） ====== */
    .stack-btn{
      position:fixed;left:12px;top:140px;z-index:1001;
      width:48px;height:48px;border-radius:12px;background:#fff;border:none;box-shadow:var(--shadow);cursor:pointer
    }

    /* ====== 左下の丸いRECとライドモード ====== */
    .rec-wrap{position:fixed;left:12px;bottom:120px;z-index:1001;display:flex;flex-direction:column;gap:12px;align-items:flex-start}
    .rec{
      width:68px;height:68px;border-radius:34px;background:#fff;box-shadow:var(--shadow);border:none;position:relative;cursor:pointer
    }
    .rec::before{content:"";position:absolute;inset:14px;border-radius:50%;background:#e11d48}
    .ride-chip{
      display:flex;align-items:center;gap:8px;background:#111827;color:#fff;border-radius:20px;padding:10px 14px;
      box-shadow:var(--shadow);border:none;cursor:pointer
    }

    /* ====== 右側：コンパス, ズーム ====== */
    .zoom-col{
      position:fixed;right:12px;top:160px;z-index:1001;display:flex;flex-direction:column;gap:10px
    }
    .zoom-btn{
      width:48px;height:48px;border-radius:12px;background:#fff;border:none;box-shadow:var(--shadow);font-size:24px;cursor:pointer
    }

    /* ====== 右下：現在地ボタン ====== */
    .loc-btn{
      position:fixed;right:12px;bottom:18px;z-index:1001;width:62px;height:62px;border-radius:31px;background:#fff;border:none;
      box-shadow:var(--shadow);cursor:pointer;display:grid;place-items:center;font-size:22px
    }

    /* ====== 雨雲コントローラ（角丸カード） ====== */
    #rvCtl{
      position:fixed;left:12px;bottom:12px;z-index:1002;background:#fff;border-radius:14px;padding:12px 14px;
      box-shadow:var(--shadow);min-width:240px;display:none
    }
    #rvCtl header{font-weight:700;margin-bottom:6px}
    #rvCtl .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    #rvCtl button{border:none;border-radius:10px;padding:8px 10px;background:var(--accent);color:#fff;cursor:pointer}
    #rvCtl button.gray{background:#9ca3af}
    #rvCtl input[type="range"]{width:130px}

    /* 旧フォーム類は隠す（機能はJSから使うので残す） */
    #controls,#summaryPanel,#back,#fab,#jumpCtl{display:none !important}
  </style>
</head>
<body>
  <!-- 上部ナビ -->
  <div class="appbar">
    <div class="row">
      <button class="iconbtn" id="btnMenu" aria-label="メニュー">☰</button>
      <div class="search-pill" title="目的地/スポットを入力">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="#64748b" stroke-width="2" stroke-linecap="round"/><circle cx="10.5" cy="10.5" r="6.5" stroke="#64748b" stroke-width="2"/></svg>
        <input id="end" placeholder="目的地 / スポットを入力" />
      </div>
    </div>
    <div class="home-chip" id="btnHome">自宅</div>
  </div>

  <!-- 「ルート作成」タブ -->
  <div class="route-tab">
    <button class="route-menu" id="makeRoute">ルート作成 ▾</button>
  </div>

  <!-- マップ -->
  <div id="map"></div>

  <!-- 左・右のオーバーレイUI -->
  <button class="stack-btn" id="btnLayers" title="レイヤー/雨雲">≡</button>

  <div class="rec-wrap">
    <button class="rec" id="btnRec" title="（将来）録画/チェックポイント"></button>
    <button class="ride-chip" id="stopsBtn">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 12h18M12 3v18" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
      ライドモード
    </button>
  </div>

  <div class="zoom-col">
    <button class="zoom-btn" id="zoomIn">＋</button>
    <button class="zoom-btn" id="zoomOut">－</button>
  </div>

  <button class="loc-btn" id="btnLocate" title="現在地へ">➤</button>

  <!-- 雨雲レーダーUI（既存ロジック流用） -->
  <div id="rvCtl">
    <header>雨雲レーダー <span class="stamp" id="rvStamp">--:--</span></header>
    <div class="row">
      <button id="rvPlay">▶︎ 再生</button>
      <button id="rvPrev">◀︎</button>
      <button id="rvNext">▶︎</button>
      <button id="rvOff" class="gray">OFF</button>
    </div>
    <div class="row" style="margin-top:6px">
      透明度 <input id="rvOpacity" type="range" min="20" max="100" value="60">
      <span id="rvOpacityVal">60%</span>
    </div>
  </div>

  <!-- 既存：隠しフォーム（スタート地点やオプションは内部で利用） -->
  <div id="controls">
    <input id="start" placeholder="出発地（例：京都駅）">
    <label><input type="checkbox" id="opt-avoid-highways"> 高速を使わない</label>
    <label><input type="checkbox" id="opt-avoid-tolls"> 有料道路を使わない</label>
    <button id="shareBtn" disabled>LINEで共有</button>
    <button id="navBtn" disabled>Googleナビで開く</button>
  </div>
  <div id="summaryPanel"><div id="summary">距離と時間はここに表示されます。</div></div>

  <!-- Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlN9ik-Y3CpEy3Uw9hXfBq0m2AoZWx_oM&libraries=places&language=ja&region=JP&callback=initMap" async defer></script>

  <script>
    let map, radarTimestamps=[], radarIndex=0, radarTimer=null, radarLayer=null, radarOpacity=0.6;
    let directionsService, directionsRenderer;

    function initMap(){
      map=new google.maps.Map(document.getElementById('map'),{
        center:{lat:35.0116,lng:135.7681},zoom:12,streetViewControl:false,mapTypeControl:false,fullscreenControl:false
      });

      // 方向サービス
      directionsService=new google.maps.DirectionsService();
      directionsRenderer=new google.maps.DirectionsRenderer({map, suppressMarkers:false});

      // プレイス補完（目的地）
      const endInput=document.getElementById('end');
      new google.maps.places.Autocomplete(endInput,{fields:["geometry","name"]});

      // ズーム制御
      document.getElementById('zoomIn').onclick=()=>map.setZoom(map.getZoom()+1);
      document.getElementById('zoomOut').onclick=()=>map.setZoom(map.getZoom()-1);

      // 現在地
      document.getElementById('btnLocate').onclick=getCurrentPosition;
      // 自宅：startに自宅を入れる体で現在地→startに
      document.getElementById('btnHome').onclick=getCurrentPosition;

      // ルート作成
      document.getElementById('makeRoute').onclick=buildRoute;

      // レイヤー/雨雲トグル
      document.getElementById('btnLayers').onclick=toggleRadar;

      // 雨雲コントロール
      document.getElementById('rvPlay').addEventListener('click',(e)=>togglePlay(e.currentTarget));
      document.getElementById('rvPrev').addEventListener('click',()=>stepFrame(-1));
      document.getElementById('rvNext').addEventListener('click',()=>stepFrame(1));
      document.getElementById('rvOff').addEventListener('click',turnRadarOff);
      document.getElementById('rvOpacity').addEventListener('input',(e)=>{
        const v=Number(e.target.value); document.getElementById('rvOpacityVal').textContent=v+'%';
        radarOpacity=v/100; if(radarLayer) rebuildCurrentRadarLayer();
      });
    }

    function getCurrentPosition(){
      if(!navigator.geolocation){alert('位置情報が使えません');return;}
      navigator.geolocation.getCurrentPosition(pos=>{
        const p={lat:pos.coords.latitude,lng:pos.coords.longitude};
        map.panTo(p); map.setZoom(Math.max(map.getZoom(),14));
        const s=document.getElementById('start'); if(s) s.value=`${p.lat.toFixed(6)},${p.lng.toFixed(6)}`;
      },err=>alert('現在地の取得に失敗しました'));
    }

    async function buildRoute(){
      const startVal=document.getElementById('start').value.trim();
      const endVal=document.getElementById('end').value.trim();
      if(!endVal){alert('目的地を入力してください');return;}

      const request={
        origin: startVal || '現在地',
        destination: endVal,
        travelMode: google.maps.TravelMode.DRIVING,
        drivingOptions: { departureTime:new Date() },
        avoidHighways: document.getElementById('opt-avoid-highways')?.checked || false,
        avoidTolls: document.getElementById('opt-avoid-tolls')?.checked || false,
        provideRouteAlternatives:false
      };
      try{
        // origin が「現在地」の場合は Geolocation → LatLngLiteral を使う
        if(!startVal && navigator.geolocation){
          await new Promise((resolve,reject)=>{
            navigator.geolocation.getCurrentPosition(p=>{
              request.origin=new google.maps.LatLng(p.coords.latitude,p.coords.longitude);
              resolve();
            },reject,{enableHighAccuracy:true,timeout:7000});
          });
        }
        const res=await directionsService.route(request);
        directionsRenderer.setDirections(res);
        // 距離時間を左上の検索ピルにプチ表示しても良い
      }catch(e){
        console.error(e); alert('ルート作成に失敗しました');
      }
    }

    /* ===== 雨雲レーダー（既存ロジックほぼそのまま） ===== */
    async function toggleRadar(){
      const ctl=document.getElementById('rvCtl');
      if(radarLayer){ turnRadarOff(); return; }
      try{
        const res=await fetch('https://api.rainviewer.com/public/weather-maps.json');
        const data=await res.json();
        radarTimestamps=[...(data?.radar?.past||[]).map(f=>f.time),...(data?.radar?.nowcast||[]).map(f=>f.time)];
        if(!radarTimestamps.length){ alert('雨雲データ取得失敗'); return; }
        radarIndex=radarTimestamps.length-1;
        fadeToFrame(radarIndex,true);
        ctl.style.display='block';
      }catch(e){ alert('雨雲データ取得エラー'); console.error(e); }
    }
    function turnRadarOff(){ stopAnimation(); map.overlayMapTypes.clear(); radarLayer=null; document.getElementById('rvCtl').style.display='none'; }
    function tileUrl(ts){ return `https://tilecache.rainviewer.com/v2/radar/${ts}/256/{z}/{x}/{y}/2/1_1.png`; }
    function buildLayer(ts,opacity){
      const t=tileUrl(ts);
      return new google.maps.ImageMapType({
        getTileUrl:(coord,zoom)=>{ const n=1<<zoom; let x=coord.x%n; if(x<0)x+=n; return t.replace('{z}',zoom).replace('{x}',x).replace('{y}',coord.y); },
        tileSize:new google.maps.Size(256,256), opacity:opacity
      });
    }
    function fadeToFrame(i,instant=false){
      if(!radarTimestamps.length) return;
      const ts=radarTimestamps[i];
      const newLayer=buildLayer(ts,0);
      map.overlayMapTypes.insertAt(0,newLayer);

      const d=new Date(ts*1000);
      document.getElementById('rvStamp').textContent=d.toLocaleString('ja-JP',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});

      const oldLayer=radarLayer; radarLayer=newLayer;
      if(instant){ radarLayer.setOpacity(radarOpacity); if(oldLayer) map.overlayMapTypes.removeAt(1); return; }

      let alpha=0;
      const fadeTimer=setInterval(()=>{
        alpha+=0.1;
        radarLayer.setOpacity(radarOpacity*alpha);
        if(oldLayer) oldLayer.setOpacity(radarOpacity*(1-alpha));
        if(alpha>=1){ clearInterval(fadeTimer); radarLayer.setOpacity(radarOpacity);
          if(oldLayer){ const arr=map.overlayMapTypes.getArray(); const idx=arr.indexOf(oldLayer); if(idx>=0) map.overlayMapTypes.removeAt(idx); }
        }
      },50);
    }
    function rebuildCurrentRadarLayer(){ if(radarLayer) fadeToFrame(radarIndex,true); }
    function stepFrame(dir){ if(!radarTimestamps.length) return; radarIndex=(radarIndex+dir+radarTimestamps.length)%radarTimestamps.length; fadeToFrame(radarIndex); }
    function togglePlay(btn){
      if(radarTimer){ clearInterval(radarTimer); radarTimer=null; btn.textContent='▶︎ 再生'; return; }
      btn.textContent='⏸ 一時停止'; radarTimer=setInterval(()=>stepFrame(1),380);
    }
    function stopAnimation(){ if(radarTimer){ clearInterval(radarTimer); radarTimer=null; } const btn=document.getElementById('rvPlay'); if(btn) btn.textContent='▶︎ 再生'; }
  </script>
</body>
</html>

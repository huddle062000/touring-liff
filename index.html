<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ライドツーリングツール</title>
<style>
  html, body { height:100%; margin:0; font-family:"Roboto","Noto Sans JP",sans-serif; overflow:hidden; }
  /* 地図を常時全画面 */
  #map { position:absolute; inset:0; width:100%; height:100vh; z-index:1; }

  /* Googleマップ風 検索バー（placeholderを「目的地」） */
  .search-wrap{
    position:absolute; top:12px; left:50%; transform:translateX(-50%);
    width:92%; max-width:420px; z-index:10;  /* z-index高めで候補が隠れないように */
  }
  .search-container{
    display:flex; align-items:center; gap:8px;
    background:#fff; border-radius:30px; padding:6px 12px;
    box-shadow:0 2px 6px rgba(0,0,0,.25);
  }
  .search-container img.logo{ width:28px; height:28px; }
  #destInput{
    flex:1; border:none; outline:none; font-size:16px; color:#333; background:transparent;
  }

  /* 現在地ボタン */
  #locateBtn{
    position:absolute; right:16px; bottom:100px; width:56px; height:56px; z-index:5;
    border:none; border-radius:50%; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.3); cursor:pointer;
  }
  #locateBtn img{ width:26px; height:26px; }
</style>
</head>
<body>
  <!-- 検索バー（マイクなし・プレースホルダは「目的地」） -->
  <div class="search-wrap">
    <div class="search-container">
      <img class="logo" src="https://upload.wikimedia.org/wikipedia/commons/e/e7/Google_Maps_icon_%282020%29.svg" alt="">
      <input id="destInput" type="text" placeholder="目的地" autocomplete="off">
    </div>
  </div>

  <!-- 地図 -->
  <div id="map"></div>

  <!-- 現在地ボタン -->
  <button id="locateBtn" title="現在地へ移動">
    <img src="https://img.icons8.com/ios-filled/50/000000/near-me.png" alt="">
  </button>

<script>
let map, marker, autocomplete;

window.initMap = function () {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 35.0116, lng: 135.7681 },
    zoom: 13,
    mapTypeControl: false, streetViewControl: false, fullscreenControl: false
  });

  // --- ここがポイント：純正Autocompleteを使用 ---
  const input = document.getElementById("destInput");
  // Places APIが未有効だとここで例外になる
  try {
    autocomplete = new google.maps.places.Autocomplete(input, {
      fields: ["geometry", "name", "formatted_address"],
      componentRestrictions: { country: ["jp"] }, // 日本優先（必要なら外してください）
      types: ["geocode", "establishment"]
    });
    autocomplete.bindTo("bounds", map);

    autocomplete.addListener("place_changed", () => {
      const place = autocomplete.getPlace();
      if (!place || !place.geometry) {
        alert("場所が見つかりませんでした。別のキーワードで試してください。");
        return;
      }
      setMarker(place.geometry.location, place.name || place.formatted_address);
    });
  } catch (e) {
    console.error(e);
    alert("Places APIが有効化されていない可能性があります。Google Cloudで“Places API”を有効にしてください。");
  }

  // 現在地ボタン
  document.getElementById("locateBtn").addEventListener("click", () => {
    if (!navigator.geolocation) { alert("この端末は現在地取得に対応していません。"); return; }
    navigator.geolocation.getCurrentPosition(
      pos => {
        const me = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        setMarker(me, "現在地");
      },
      () => alert("現在地を取得できませんでした。位置情報の許可をご確認ください。"),
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });
};

function setMarker(latlng, title){
  if (marker) marker.setMap(null);
  marker = new google.maps.Marker({ position: latlng, map, title: title || "目的地" });
  map.panTo(latlng);
  map.setZoom(15);
}
</script>

<!-- Placesライブラリを読み込むこと（必須） -->
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlN9ik-Y3CpEy3Uw9hXfBq0m2AoZWx_oM&callback=initMap&libraries=places"></script>
</body>
</html>

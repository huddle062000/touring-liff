<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ツーリングルート共有（LINE × Google Maps）</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: sans-serif; }
    header { padding: 10px 16px; background: #06c755; color: white; }
    h1 { font-size: 18px; margin: 0; }
    #map { width: 100%; height: 60vh; }
    .panel { padding: 12px 16px; }
    input { padding: 8px; width: 100%; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 6px; }
    button { padding: 10px; font-size: 16px; border: none; border-radius: 8px; background: #06c755; color: white; width: 100%; }
    button:disabled { opacity: 0.5; }
      /* 既存のstyleの末尾に追加 */
  body.fullmap header,
  body.fullmap .panel { display: none; }

  body.fullmap #map { height: 100vh !important; }

  #back { 
    position: fixed; top: 10px; left: 10px; z-index: 1000;
    background: #06c755; color: #fff; border: none; border-radius: 8px;
    padding: 8px 12px; display: none;
  }
  body.fullmap #back { display: inline-block; }
  </style>
</head>
<body>
  <header><h1>ツーリングルート共有</h1></header>
    <!-- 追加：全画面時のみ見える戻るボタン -->
  <button id="back" type="button">戻る</button>

  <div class="panel">
    <!-- 出発地入力 + 現在地ボタン（重複なし・ID一意） -->
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="start" placeholder="出発地を入力（例：京都駅）" style="flex:1">
      <button type="button" id="btn-loc" style="width:auto; white-space:nowrap;">現在地</button>
    </div>

    <input id="end" placeholder="目的地を入力（例：美山 かやぶきの里）">

    <!-- 経路オプション -->
    <div style="display:flex; gap:12px; align-items:center; margin:6px 0 10px">
      <label style="display:flex; gap:6px; align-items:center;">
        <input type="checkbox" id="opt-avoid-highways">
        高速を使わない
      </label>
      <label style="display:flex; gap:6px; align-items:center;">
        <input type="checkbox" id="opt-avoid-tolls">
        有料道路を使わない
      </label>
    </div>

    <button id="makeRoute">ルートを作る</button>
    <button id="shareBtn" disabled>LINEで共有</button>
  </div>

  <div id="map"></div>

  <!-- 距離・時間の表示エリア -->
  <div class="panel" style="padding-top:8px">
    <div id="summary" style="font-size:14px;line-height:1.6;color:#333"></div>
  </div>

  <!-- LINE SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = "2008438848-3gJlGQvy";
    async function initLIFF() {
      await liff.init({ liffId: LIFF_ID });
      const canShare = liff.isApiAvailable('shareTargetPicker');
      document.getElementById('shareBtn').disabled = !canShare;
    }
    initLIFF();
  </script>

  <!-- Google Maps API（initMapコールバック付き） -->
  <script>
    let map, directionsService, directionsRenderer;
    let geocoder, currentMarker; // 住所変換と現在地マーカー
    const GOOGLE_MAPS_API_KEY = "AIzaSyBlN9ik-Y3CpEy3Uw9hXfBq0m2AoZWx_oM";
  </script>
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlN9ik-Y3CpEy3Uw9hXfBq0m2AoZWx_oM&libraries=places&language=ja&callback=initMap"
    async defer></script>

  <script>
    document.getElementById('makeRoute').addEventListener('click', makeRoute);
    document.getElementById('shareBtn').addEventListener('click', shareOnLINE);
    document.getElementById('btn-loc').addEventListener('click', fillWithCurrentLocation);

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), { center: { lat: 35.0116, lng: 135.7681 }, zoom: 9 });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map });
      geocoder = new google.maps.Geocoder(); // 逆ジオコーディング用
    }
    window.initMap = initMap;

    // 現在地ボタン処理
    function fillWithCurrentLocation() {
      if (!navigator.geolocation) { alert('この端末では位置情報が使えません'); return; }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          const loc = { lat, lng };

          map.setCenter(loc);
          map.setZoom(14);
          if (currentMarker) currentMarker.setMap(null);
          currentMarker = new google.maps.Marker({ position: loc, map, title: '現在地' });

          geocoder.geocode({ location: loc }, (results, status) => {
            if (status === 'OK' && results && results[0]) {
              document.getElementById('start').value = results[0].formatted_address;
            } else {
              document.getElementById('start').value = `${lat.toFixed(6)},${lng.toFixed(6)}`;
            }
          });
        },
        (err) => {
          const msg = {1:'位置情報の権限が拒否されました',2:'位置情報が取得できませんでした',3:'位置情報の取得がタイムアウトしました'}[err.code] || '位置情報の取得に失敗しました';
          alert(msg);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    async function makeRoute() {
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;
      if (!start || !end) { alert('出発地と目的地を入力してください'); return; }

      const avoidHighways = document.getElementById('opt-avoid-highways').checked;
      const avoidTolls = document.getElementById('opt-avoid-tolls').checked;

      const req = {
        origin: start,
        destination: end,
        travelMode: google.maps.TravelMode.DRIVING,
        avoidHighways,
        avoidTolls
      };

      directionsService.route(req, (result, status) => {
        if (status === 'OK') {
          directionsRenderer.setDirections(result);
          const leg = result.routes[0].legs[0];

          const s = document.getElementById('summary');
          const optTxt = `（高速: ${avoidHighways ? '使わない' : '使う'} / 有料: ${avoidTolls ? '使わない' : '使う'}）`;
          s.textContent = `距離: ${leg.distance.text}　時間: ${leg.duration.text} ${optTxt}`;

          const avoidParams = [];
          if (avoidHighways) avoidParams.push('highways');
          if (avoidTolls)    avoidParams.push('tolls');
          const avoidStr = avoidParams.length ? `&avoid=${avoidParams.join('%7C')}` : '';

          const gmapsUrl =
            'https://www.google.com/maps/dir/?api=1' +
            `&origin=${encodeURIComponent(leg.start_address)}` +
            `&destination=${encodeURIComponent(leg.end_address)}` +
            `&travelmode=driving${avoidStr}`;

          window._sharePayload = {
            text:
              `出発地: ${leg.start_address}\n` +
              `目的地: ${leg.end_address}\n` +
              `距離: ${leg.distance.text}\n` +
              `時間: ${leg.duration.text}\n` +
              `設定: 高速=${avoidHighways ? '使わない' : '使う'} / 有料=${avoidTolls ? '使わない' : '使う'}\n\n` +
              `ルートを見る: ${gmapsUrl}`,
            gmapsUrl,
            start: {
              title: '出発地',
              address: leg.start_address,
              lat: leg.start_location.lat(),
              lng: leg.start_location.lng(),
            },
            end: {
              title: '目的地',
              address: leg.end_address,
              lat: leg.end_location.lat(),
              lng: leg.end_location.lng(),
            }
          };

          window._shareText =
            `出発地: ${leg.start_address}\n目的地: ${leg.end_address}\n距離: ${leg.distance.text}\n時間: ${leg.duration.text}\n` +
            `設定: 高速=${avoidHighways ? '使わない' : '使う'} / 有料=${avoidTolls ? '使わない' : '使う'}\n\n` +
            `ルートを見る: ${gmapsUrl}`;

          document.getElementById('shareBtn').disabled = false;

        } else {
          alert('ルートを作れませんでした');
          document.getElementById('summary').textContent = '';
        }
      });
    }

    // 共有：位置情報 → テキストURLにフォールバック
    async function shareOnLINE() {
      try {
        const payload = window._sharePayload;
        if (!payload) { alert('先に「ルートを作る」で経路を作成してください。'); return; }

        if (liff.isInClient() && liff.isApiAvailable('shareTargetPicker')) {
          try {
            const res = await liff.shareTargetPicker([
              { type: 'location', title: payload.start.title, address: payload.start.address, latitude: payload.start.lat, longitude: payload.start.lng },
              { type: 'location', title: payload.end.title,   address: payload.end.address,   latitude: payload.end.lat,   longitude: payload.end.lng },
              { type: 'text', text: `ルートを見る：\n${payload.gmapsUrl}` }
            ]);
            if (res) alert('送信しました！');
            return;
          } catch (e) {
            console.warn('location送信に失敗。テキストにフォールバックします:', e);
          }
        }

        const shareUrl = 'https://line.me/R/share?text=' + encodeURIComponent(payload.text);
        window.open(shareUrl, '_blank');
      } catch (e) {
        alert('共有に失敗しました：\n' + (e?.message || String(e)));
      }
    }
  </script>
  <script>
  // 既存のリスナー群の下あたりに追加
  document.getElementById('back').addEventListener('click', () => {
    document.body.classList.remove('fullmap');
    // 必要があればスクロール位置を戻す
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  async function makeRoute() {
    const start = document.getElementById('start').value;
    const end   = document.getElementById('end').value;
    if (!start || !end) { alert('出発地と目的地を入力してください'); return; }

    const avoidHighways = document.getElementById('opt-avoid-highways').checked;
    const avoidTolls    = document.getElementById('opt-avoid-tolls').checked;

    const req = {
      origin: start,
      destination: end,
      travelMode: google.maps.TravelMode.DRIVING,
      avoidHighways,
      avoidTolls
    };

    directionsService.route(req, (result, status) => {
      if (status === 'OK') {
        directionsRenderer.setDirections(result);

        // ★ ここで全画面化（前面に地図だけ）に切り替え
        document.body.classList.add('fullmap');

        const leg = result.routes[0].legs[0];
        const s = document.getElementById('summary');
        const optTxt = `（高速: ${avoidHighways ? '使わない' : '使う'} / 有料: ${avoidTolls ? '使わない' : '使う'}）`;
        s.textContent = `距離: ${leg.distance.text}　時間: ${leg.duration.text} ${optTxt}`;

        // 以降はあなたの既存コード（共有用URL生成など）そのままでOK
        /* ... 既存の gmapsUrl 作成＆ window._sharePayload の設定 ... */

      } else {
        alert('ルートを作れませんでした');
        document.getElementById('summary').textContent = '';
      }
    });
  }
</script>
</body>
</html>









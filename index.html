<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ©ã‚¤ãƒ‰ãƒ„ãƒ¼ãƒªãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ï¼ˆLINE Ã— Google Mapsï¼‰</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: sans-serif; }
    header { padding: 10px 16px; background: #06c755; color: white; }
    h1 { font-size: 18px; margin: 0; }

    #map { width: 100%; height: 50vh; }
    @media (min-width: 769px){ #map { height: 60vh; } }

    .panel { padding: 12px 16px; background:#fff; }
    input, select { padding: 8px; width: 100%; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 6px; }
    button { padding: 10px; font-size: 16px; border: none; border-radius: 8px; background: #06c755; color: white; width: 100%; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: default; }
    label.chk { display:flex; gap:6px; align-items:center; margin-right:12px; }

    body.fullmap header, body.fullmap #controls { display: none; }
    body.fullmap #map { height: 100vh !important; }

    #back { position: fixed; top: 10px; left: 10px; z-index: 1000; background: #06c755; color: #fff; border: none; border-radius: 8px; padding: 8px 12px; display: none; }
    body.fullmap #back { display: inline-block; }

    #fab {
      position: fixed; right: 12px; bottom: 16px; z-index: 1001;
      gap: 8px; display: none; flex-direction: column; align-items: end;
    }
    #fab button {
      padding: 10px 14px; border: none; border-radius: 20px; background: #06c755; color: #fff;
      font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,.2); white-space: nowrap; width: auto; cursor: pointer;
    }
    body.fullmap #fab { display: flex; }

    #jumpCtl { position: fixed; right: 12px; bottom: 16px; z-index: 1000;
      padding: 10px 14px; border: none; border-radius: 20px; background: #06c755; color:#fff; font-size: 14px; box-shadow:0 2px 8px rgba(0,0,0,.2); }
    body.fullmap #jumpCtl { display:none; }

    /* ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆ ãƒ‰ãƒ­ãƒ¯ãƒ¼ */
    #stopsDrawer {
      position: fixed; right: 12px; top: 12px; z-index: 1001;
      background: rgba(255,255,255,0.98); border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.2);
      width: min(360px, 92vw); max-height: 72vh; display: none; flex-direction: column;
    }
    #stopsDrawer header { display:flex; justify-content: space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #eee; }
    #stopsList { overflow:auto; max-height: 54vh; padding: 8px 10px; }
    .stopItem { border: 1px solid #eee; border-radius: 10px; padding: 8px 10px; margin-bottom: 8px; cursor: pointer; }
    .stopItem:hover { background: #fafafa; }
    .meta { color:#666; font-size:12px; display:flex; gap:8px; flex-wrap:wrap; }
    .controls { padding:10px 12px; display:flex; gap:10px; align-items:center; border-bottom:1px solid #eee; flex-wrap:wrap; }
    .controls .group { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .badge { background:#06c755; color:#fff; border-radius:12px; padding:2px 8px; font-size:12px; }

    /* ç°¡æ˜“ã‚¨ãƒ©ãƒ¼ãƒãƒŠãƒ¼ */
    #errBanner {
      position: fixed; left: 12px; top: 12px; z-index: 2000;
      background: #ffefef; color:#900; border:1px solid #f5b5b5; padding:8px 12px; border-radius:8px; display:none;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
    }

    /* â–¼ é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒ‘ãƒãƒ«ï¼ˆWindyåŸ‹ã‚è¾¼ã¿ï¼‰ â–¼ */
    #radarPanel {
      position: fixed; right: 12px; bottom: 12px; z-index: 1100;
      width: min(480px, 96vw); height: min(70vh, 80vh);
      background: #fff; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,.25);
      display: none; overflow: hidden;
    }
    #radarPanel header {
      display:flex; justify-content: space-between; align-items:center;
      padding:8px 10px; border-bottom:1px solid #eee; background:#f7f7f7;
    }
    #radarClose { width:auto; background:#999; }
    #radarFrame { width: 100%; height: calc(100% - 42px); border: 0; display: block; }
  </style>
</head>
<body>
  <header><h1>ãƒ©ã‚¤ãƒ‰ãƒ„ãƒ¼ãƒªãƒ³ã‚°ãƒ„ãƒ¼ãƒ«</h1></header>

  <div id="errBanner"></div>

  <button id="jumpCtl" type="button">æ“ä½œãƒ‘ãƒãƒ«</button>
  <div id="map"></div>

  <!-- ä¸Šï¼šæ“ä½œãƒ‘ãƒãƒ« -->
  <div id="controls" class="panel">
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="start" placeholder="å‡ºç™ºåœ°ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šäº¬éƒ½é§…ï¼‰" style="flex:1">
      <button type="button" id="btn-loc" style="width:auto; white-space:nowrap;">ç¾åœ¨åœ°</button>
    </div>
    <input id="end" placeholder="ç›®çš„åœ°ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šç¾å±± ã‹ã‚„ã¶ãã®é‡Œï¼‰">
    <div style="display:flex; gap:12px; align-items:center; margin:6px 0 10px; flex-wrap:wrap;">
      <label class="chk"><input type="checkbox" id="opt-avoid-highways"> é«˜é€Ÿã‚’ä½¿ã‚ãªã„</label>
      <label class="chk"><input type="checkbox" id="opt-avoid-tolls"> æœ‰æ–™é“è·¯ã‚’ä½¿ã‚ãªã„</label>
    </div>
    <button id="makeRoute">ãƒ«ãƒ¼ãƒˆã‚’ä½œã‚‹</button>
    <button id="shareBtn" disabled>LINEã§å…±æœ‰</button>
    <button id="navBtn" disabled>GoogleãƒŠãƒ“ã§é–‹ã</button>
    <button id="stopsBtn" disabled>ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆææ¡ˆ</button>
    <!-- â–¼ è¿½åŠ ï¼šé›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ -->
    <button id="radarBtn" type="button">é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼</button>
  </div>

  <!-- ä¸‹ï¼šã‚µãƒãƒªãƒ¼ï¼ˆè·é›¢ãƒ»æ™‚é–“ã®ã¿ï¼‰ -->
  <div id="summaryPanel" class="panel" style="padding-top:8px">
    <div id="summary" style="font-size:14px;line-height:1.6;color:#333">è·é›¢ã¨æ™‚é–“ã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
  </div>

  <!-- å…¨ç”»é¢æ™‚ã®æ“ä½œ -->
  <button id="back" type="button">æˆ»ã‚‹</button>
  <div id="fab">
    <button id="navBtnFab" disabled>GoogleãƒŠãƒ“é–‹å§‹</button>
    <button id="shareBtnFab" disabled>LINEã§å…±æœ‰</button>
    <button id="stopsBtnFab" disabled>ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆææ¡ˆ</button>
    <!-- â–¼ è¿½åŠ ï¼šé›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ï¼ˆFABï¼‰ -->
    <button id="radarBtnFab" type="button">é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼</button>
  </div>

  <!-- ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆ ãƒ‰ãƒ­ãƒ¯ãƒ¼ -->
  <div id="stopsDrawer">
    <header>
      <div>ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆå€™è£œ <span id="stopsCount" class="badge">0ä»¶</span></div>
      <button id="stopsClose" style="width:auto;background:#999;">é–‰ã˜ã‚‹</button>
    </header>
    <div class="controls">
      <div class="group">
        <label class="chk"><input type="checkbox" class="stop-type" value="é“ã®é§…" checked>é“ã®é§…</label>
        <label class="chk"><input type="checkbox" class="stop-type" value="cafe" checked>ã‚«ãƒ•ã‚§</label>
        <label class="chk"><input type="checkbox" class="stop-type" value="gas_station" checked>GS</label>
        <label class="chk"><input type="checkbox" class="stop-type" value="parking" checked>é§è»Šå ´</label>
        <label class="chk"><input type="checkbox" class="stop-type" value="tourist_attraction">è¦³å…‰</label>
      </div>
      <div class="group">
        åŠå¾„
        <select id="stopRadius" style="width:auto;">
          <option value="2000">2km</option>
          <option value="3000">3km</option>
          <option value="5000" selected>5km</option>
          <option value="8000">8km</option>
        </select>
        <label class="chk"><input type="checkbox" id="onlyOpen">å–¶æ¥­ä¸­ã®ã¿</label>
      </div>
      <button id="stopsRefresh" style="width:auto;">å†æ¤œç´¢</button>
    </div>
    <div id="stopsList"></div>
  </div>

  <!-- â–¼ é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒ‘ãƒãƒ«ï¼ˆWindyï¼‰ -->
  <div id="radarPanel">
    <header>
      <div>é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ï¼ˆWindyï¼‰</div>
      <button id="radarClose">é–‰ã˜ã‚‹</button>
    </header>
    <iframe id="radarFrame" title="Windy Radar"></iframe>
  </div>

  <!-- LINE SDKï¼ˆä»»æ„ï¼‰ -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = "2008438848-3gJlGQvy";
    (async function initLIFFSafe() {
      try { if (window.liff) { await liff.init({ liffId: LIFF_ID }); } }
      catch(e){ console.warn('LIFF init skipped:', e); }
    })();
  </script>

  <!-- ====== ã¾ãšï¼šå¤‰æ•°ã¨é–¢æ•°(å«ã‚€ initMap)ã‚’å®šç¾© ====== -->
  <script>
    let map, directionsService, directionsRenderer, geocoder, placesService, currentMarker, infoWnd;
    let lastRouteResult = null;
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    let stopMarkers = [];
    const stopIcon = { cafe:"â˜•", gas_station:"â›½", parking:"ğŸ…¿", tourist_attraction:"ğŸ“", michi:"ğŸ¯" };

    // ç°¡æ˜“ã‚¨ãƒ©ãƒ¼ãƒãƒŠãƒ¼è¡¨ç¤º
    function showErr(msg){
      const el = document.getElementById('errBanner');
      el.textContent = msg; el.style.display = 'block';
      setTimeout(()=>{ el.style.display='none'; }, 4000);
    }

    // ---- initMapï¼ˆå…ˆã«å®šç¾©ï¼ï¼‰----
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), { center: { lat: 35.0116, lng: 135.7681 }, zoom: 9 });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map });
      geocoder = new google.maps.Geocoder();
      placesService = new google.maps.places.PlacesService(map);
      infoWnd = new google.maps.InfoWindow();
    }
    // callback=initMap ç”¨ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã¸
    window.initMap = initMap;

    // ---- UIã‚¤ãƒ™ãƒ³ãƒˆ ----
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('makeRoute').addEventListener('click', makeRoute);
      document.getElementById('shareBtn').addEventListener('click', shareOnLINE);
      document.getElementById('navBtn').addEventListener('click', openNavigation);
      document.getElementById('stopsBtn').addEventListener('click', () => suggestStops(true));
      document.getElementById('btn-loc').addEventListener('click', fillWithCurrentLocation);

      document.getElementById('shareBtnFab').addEventListener('click', shareOnLINE);
      document.getElementById('navBtnFab').addEventListener('click', openNavigation);
      document.getElementById('stopsBtnFab').addEventListener('click', () => suggestStops(true));

      document.getElementById('back').addEventListener('click', () => {
        document.body.classList.remove('fullmap');
        if (window.google && map) google.maps.event.trigger(map, 'resize');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      document.getElementById('stopsClose').addEventListener('click', () => {
        document.getElementById('stopsDrawer').style.display = 'none';
      });
      document.getElementById('stopsRefresh').addEventListener('click', () => suggestStops(false));

      document.getElementById('jumpCtl').addEventListener('click', () => {
        document.getElementById('controls').scrollIntoView({ behavior:'smooth', block:'start' });
      });

      // â–¼ é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ï¼ˆé€šå¸¸ãƒœã‚¿ãƒ³ / FAB / é–‰ã˜ã‚‹ï¼‰
      document.getElementById('radarBtn').addEventListener('click', openRadarPanel);
      document.getElementById('radarBtnFab').addEventListener('click', openRadarPanel);
      document.getElementById('radarClose').addEventListener('click', () => {
        document.getElementById('radarPanel').style.display = 'none';
      });
    });

    // ---- ç¾åœ¨åœ° ----
    function fillWithCurrentLocation() {
      if (!navigator.geolocation) { alert('ã“ã®ç«¯æœ«ã§ã¯ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“'); return; }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude, lng = pos.coords.longitude, loc = { lat, lng };
          map.setCenter(loc); map.setZoom(12);
          if (currentMarker) currentMarker.setMap(null);
          currentMarker = new google.maps.Marker({ position: loc, map, title: 'ç¾åœ¨åœ°' });
          geocoder.geocode({ location: loc }, (results, status) => {
            document.getElementById('start').value =
              (status === 'OK' && results && results[0]) ? results[0].formatted_address : `${lat.toFixed(6)},${lng.toFixed(6)}`;
          });
        },
        (err) => {
          const msg = {1:'ä½ç½®æƒ…å ±ã®æ¨©é™ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ',2:'ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ',3:'ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ'}[err.code] || 'ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
          alert(msg);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    // ---- ãƒ«ãƒ¼ãƒˆä½œæˆ ----
    function makeRoute() {
      const start = document.getElementById('start').value;
      const end   = document.getElementById('end').value;
      if (!start || !end) { alert('å‡ºç™ºåœ°ã¨ç›®çš„åœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

      const avoidHighways = document.getElementById('opt-avoid-highways').checked;
      const avoidTolls    = document.getElementById('opt-avoid-tolls').checked;

      const req = { origin: start, destination: end, travelMode: google.maps.TravelMode.DRIVING, avoidHighways, avoidTolls };

      directionsService.route(req, (result, status) => {
        if (status === 'OK') {
          lastRouteResult = result;
          directionsRenderer.setDirections(result);

          document.body.classList.add('fullmap');
          if (window.google && map) google.maps.event.trigger(map, 'resize');

          const leg = result.routes[0].legs[0];
          const optTxt = `ï¼ˆé«˜é€Ÿ: ${avoidHighways ? 'ä½¿ã‚ãªã„' : 'ä½¿ã†'} / æœ‰æ–™: ${avoidTolls ? 'ä½¿ã‚ãªã„' : 'ä½¿ã†'}ï¼‰`;
          document.getElementById('summary').textContent = `è·é›¢: ${leg.distance.text}ã€€æ™‚é–“: ${leg.duration.text} ${optTxt}`;

          const avoidParams = [];
          if (avoidHighways) avoidParams.push('highways');
          if (avoidTolls)    avoidParams.push('tolls');
          const avoidStr = avoidParams.length ? `&avoid=${avoidParams.join('%7C')}` : '';

          const gmapsUrl   = 'https://www.google.com/maps/dir/?api=1'
            + `&origin=${encodeURIComponent(leg.start_address)}`
            + `&destination=${encodeURIComponent(leg.end_address)}`
            + `&travelmode=driving${avoidStr}`;
          const gmapsNavUrl= 'https://www.google.com/maps/dir/?api=1'
            + `&origin=${encodeURIComponent(leg.start_address)}`
            + `&destination=${encodeURIComponent(leg.end_address)}`
            + `&travelmode=driving&dir_action=navigate`;

          window._sharePayload = {
            text:
              `å‡ºç™ºåœ°: ${leg.start_address}\n` +
              `ç›®çš„åœ°: ${leg.end_address}\n` +
              `è·é›¢: ${leg.distance.text}\n` +
              `æ™‚é–“: ${leg.duration.text}\n` +
              `è¨­å®š: é«˜é€Ÿ=${avoidHighways ? 'ä½¿ã‚ãªã„' : 'ä½¿ã†'} / æœ‰æ–™=${avoidTolls ? 'ä½¿ã‚ãªã„' : 'ä½¿ã†'}\n\n` +
              `ãƒ«ãƒ¼ãƒˆã‚’è¦‹ã‚‹: ${gmapsUrl}`,
            gmapsUrl, gmapsNavUrl
          };

          document.getElementById('shareBtnFab').disabled = false;
          document.getElementById('navBtnFab').disabled   = false;
          document.getElementById('stopsBtnFab').disabled = false;
          document.getElementById('stopsBtn').disabled    = false;
        } else {
          showErr('ãƒ«ãƒ¼ãƒˆã‚’ä½œã‚Œã¾ã›ã‚“ã§ã—ãŸï¼ˆ' + status + 'ï¼‰');
          document.getElementById('summary').textContent = '';
        }
      });
    }

    // ---- ãƒŠãƒ“ ----
    function openNavigation() {
      if (!window._sharePayload) { alert('å…ˆã«ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚'); return; }
      const url = isMobile ? window._sharePayload.gmapsNavUrl : window._sharePayload.gmapsUrl;
      window.open(url, '_blank');
      if (!isMobile) setTimeout(()=>alert('PCãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŸ³å£°ãƒŠãƒ“ã¯ä½¿ãˆã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§çµŒè·¯ã‚’é–‹ãã¾ã—ãŸã€‚'), 300);
    }

    // ---- LINEå…±æœ‰ ----
    async function shareOnLINE() {
      try {
        const payload = window._sharePayload;
        if (!payload) { alert('å…ˆã«ã€Œãƒ«ãƒ¼ãƒˆã‚’ä½œã‚‹ã€ã§çµŒè·¯ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚'); return; }
        if (window.liff && liff.isInClient && liff.isInClient() && liff.isApiAvailable && liff.isApiAvailable('shareTargetPicker')) {
          try { const res = await liff.shareTargetPicker([{ type: 'text', text: payload.text }]); if (res) alert('é€ä¿¡ã—ã¾ã—ãŸï¼'); return; }
          catch (e) { console.warn('shareTargetPickerå¤±æ•—:', e); }
        }
        const shareUrl = 'https://line.me/R/share?text=' + encodeURIComponent(payload.text);
        window.open(shareUrl, '_blank');
      } catch (e) { alert('å…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸï¼š\n' + (e?.message || String(e))); }
    }

    /* ===== ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆ ===== */
    function suggestStops(openDrawerFirst = true) {
      if (!lastRouteResult) { alert('å…ˆã«ãƒ«ãƒ¼ãƒˆã‚’ä½œã£ã¦ãã ã•ã„'); return; }
      const typesChecked = [...document.querySelectorAll('.stop-type:checked')].map(el => el.value);
      if (!typesChecked.length) { alert('æ¢ã™ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
      const radius = Number(document.getElementById('stopRadius').value);
      const openNow = document.getElementById('onlyOpen').checked;

      const route = lastRouteResult.routes[0];
      const leg = route.legs[0];
      const endLoc = leg.end_location;
      const midLoc = getRouteMidpoint(route);

      clearStopMarkers();
      const tasks = [];
      for (const t of typesChecked) {
        if (t === 'é“ã®é§…') {
          tasks.push(nearbySearchKeyword(endLoc, 'é“ã®é§…', radius, openNow));
          tasks.push(nearbySearchKeyword(midLoc, 'é“ã®é§…', radius, openNow));
        } else {
          tasks.push(nearbySearchType(endLoc, t, radius, openNow));
          tasks.push(nearbySearchType(midLoc, t, radius, openNow));
        }
      }

      Promise.all(tasks).then(arrs => {
        const flat = arrs.flat();
        const seen = new Set(), unique = [];
        for (const p of flat) { if (!seen.has(p.place_id)) { seen.add(p.place_id); unique.push(p); } }
        unique.sort((a,b) => (b.rating||0) - (a.rating||0) || (b.user_ratings_total||0)-(a.user_ratings_total||0));
        const top = unique.slice(0, 20);
        renderStops(top, leg);
        if (openDrawerFirst) document.getElementById('stopsDrawer').style.display = 'flex';
      });
    }

    function nearbySearchType(location, type, radius, openNow){
      return new Promise(resolve => {
        placesService.nearbySearch({ location, radius, type, openNow }, (res, status) => {
          if (status === 'OK' && res && res.length) return resolve(res);
          placesService.textSearch({ location, radius, query: type, openNow }, (res2, status2) => {
            resolve(status2 === 'OK' && res2 ? res2 : []);
          });
        });
      });
    }

    function nearbySearchKeyword(location, keyword, radius, openNow){
      return new Promise(resolve => {
        placesService.nearbySearch({ location, radius, keyword, openNow }, async (res, status) => {
          if (status === 'OK' && res && res.length) return resolve(res);
          const altWords = keyword === 'é“ã®é§…'
            ? ['é“ã®é§…', 'é“ã®é§… ä¼‘æ†©', 'é“ã®é§… ãƒ‰ãƒ©ã‚¤ãƒ–', 'ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¤ãƒ³', 'ä¼‘æ†©æ‰€']
            : [keyword];
          for (const q of altWords) {
            const r = await new Promise(r2 => placesService.textSearch({ location, radius, query: q, openNow }, (res2, st2)=>r2(st2==='OK'&&res2?res2:[])));
            if (r.length) return resolve(r);
          }
          resolve([]);
        });
      });
    }

    function renderStops(results, leg) {
      const list = document.getElementById('stopsList'); list.innerHTML = '';
      document.getElementById('stopsCount').textContent = `${results.length}ä»¶`;

      results.forEach(place => {
        const pos = place.geometry.location;
        const typeKey = (place.types||[]).find(t => stopIcon[t]) ? (place.types||[]).find(t => stopIcon[t]) : (place.name.includes('é“ã®é§…') ? 'michi' : 'tourist_attraction');
        const marker = new google.maps.Marker({
          position: pos, map, label: { text: stopIcon[typeKey] || 'ğŸ“', color: '#000', fontSize: '16px' }
        });
        marker.addListener('click', () => openInfo(place, leg));
        stopMarkers.push(marker);

        const item = document.createElement('div');
        item.className = 'stopItem';
        const distDur = estimateDetour(leg, pos);
        item.innerHTML = `
          <div style="font-weight:700">${place.name}</div>
          <div class="meta">
            <span>${place.vicinity || place.formatted_address || ''}</span>
            <span>â˜…${place.rating || '-'}ï¼ˆ${place.user_ratings_total || 0}ä»¶ï¼‰</span>
            ${distDur ? `<span>${distDur}</span>` : ''}
            ${place.opening_hours?.open_now !== undefined ? `<span>${place.opening_hours.open_now ? 'å–¶æ¥­ä¸­' : 'å–¶æ¥­æ™‚é–“å¤–'}</span>` : ''}
          </div>`;
        item.addEventListener('click', () => { map.panTo(pos); map.setZoom(15); openInfo(place, leg); });
        list.appendChild(item);
      });

      if (!results.length) {
        list.innerHTML = `<div style="padding:10px;color:#666;">
          ä¼‘æ†©ã‚¹ãƒãƒƒãƒˆã®å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åŠå¾„ã‚’åºƒã’ã‚‹ã‹ã€ã‚«ãƒ†ã‚´ãƒªã‚’å¢—ã‚„ã—ã¦å†æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚
        </div>`;
      }
    }

    function openInfo(place, leg){
      const pos = place.geometry.location;
      const navUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(leg.end_address)}&destination=${encodeURIComponent(place.name)}&destination_place_id=${place.place_id}&travelmode=driving`;
      const detour = estimateDetour(leg, pos) || '';
      infoWnd.setContent(`
        <div style="max-width:260px">
          <div style="font-weight:700;margin-bottom:4px">${place.name}</div>
          <div style="font-size:12px;color:#666;margin-bottom:6px">${place.vicinity || place.formatted_address || ''}</div>
          <div class="meta" style="margin-bottom:6px">
            <span>â˜…${place.rating || '-'}ï¼ˆ${place.user_ratings_total || 0}ä»¶ï¼‰</span>
            ${detour ? `<span>${detour}</span>` : ''}
            ${place.opening_hours?.open_now !== undefined ? `<span>${place.opening_hours.open_now ? 'å–¶æ¥­ä¸­' : 'å–¶æ¥­æ™‚é–“å¤–'}</span>` : ''}
          </div>
          <a href="${navUrl}" target="_blank" style="display:inline-block;background:#06c755;color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none;">ã“ã“ã¸ãƒŠãƒ“</a>
        </div>`);
      infoWnd.open({ map, position: pos });
    }

    function clearStopMarkers(){ stopMarkers.forEach(m => m.setMap(null)); stopMarkers = []; }

    function getRouteMidpoint(route){
      const path = route.overview_path || [];
      if (path.length === 0) return route.legs[0].start_location;
      return path[Math.floor(path.length/2)];
    }

    function estimateDetour(leg, pos){
      const toRad = x => x*Math.PI/180, lat1 = leg.end_location.lat(), lon1 = leg.end_location.lng(), lat2 = pos.lat(), lon2 = pos.lng();
      const R=6371000, dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*sin2(dLon/2);
      function sin2(x){ return Math.sin(x)**2; }
      const d=2*R*Math.asin(Math.sqrt(a));
      const km = (d/1000).toFixed(1);
      return `ç›®çš„åœ°ã‹ã‚‰ç´„${km}km`;
    }

    /* ===== é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ï¼ˆWindyåŸ‹ã‚è¾¼ã¿ï¼‰ ===== */
    function openRadarPanel(){
      const panel = document.getElementById('radarPanel');
      const frame = document.getElementById('radarFrame');

      // ç¾åœ¨ã®åœ°å›³ä¸­å¿ƒï¼†ã‚ºãƒ¼ãƒ ã‚’Windyã¸åæ˜ 
      const c = map.getCenter();
      const z = map.getZoom();
      // Windyã®ã‚ºãƒ¼ãƒ ã¯æ¦‚ã­Googleã¨åŒç­‰ã‚¹ã‚±ãƒ¼ãƒ«ã§OK
      const lat = c.lat().toFixed(4);
      const lon = c.lng().toFixed(4);
      const zoom = Math.max(4, Math.min(12, z)); // ã ã„ãŸã„ã®ç¯„å›²ã«ä¸¸ã‚ã‚‹

      const windyURL = `https://embed.windy.com/embed2.html` +
        `?lat=${lat}&lon=${lon}` +
        `&zoom=${zoom}` +
        `&level=surface` +
        `&overlay=rain` +          // é›¨é‡ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—
        `&product=radar` +         // ãƒ¬ãƒ¼ãƒ€ãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        `&menu=&message=&marker=` +
        `&calendar=` +
        `&pressure=` +
        `&type=map` +
        `&location=coordinates` +
        `&detail=&detailLat=${lat}&detailLon=${lon}` +
        `&metricWind=default&metricTemp=default` +
        `&radarRange=-1` +
        `&lang=ja`;

      // è¡¨ç¤ºã®ãŸã³ã«æ›´æ–°ï¼ˆç¾åœ¨åœ°ã«è¿½å¾“ï¼‰
      frame.src = windyURL;
      panel.style.display = 'block';
    }
  </script>

  <!-- ====== æ¬¡ã«ï¼šGoogle Maps ã‚’èª­ã¿è¾¼ã‚€ï¼ˆinitMap ã¯æ—¢ã«å®šç¾©æ¸ˆã¿ï¼‰ ====== -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlN9ik-Y3CpEy3Uw9hXfBq0m2AoZWx_oM&libraries=places,geometry&language=ja&region=JP&callback=initMap" async defer></script>
</body>
</html>

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ライドツーリングツール（LINE × Google Maps）</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: sans-serif; }
    header { padding: 10px 16px; background: #06c755; color: white; }
    h1 { font-size: 18px; margin: 0; }
    #map { width: 100%; height: 60vh; }
    .panel { padding: 12px 16px; }
    input { padding: 8px; width: 100%; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 6px; }
    button { padding: 10px; font-size: 16px; border: none; border-radius: 8px; background: #06c755; color: white; width: 100%; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: default; }

    /* 全画面表示用スタイル */
    body.fullmap header,
    body.fullmap .panel { display: none; }
    body.fullmap #map { height: 100vh !important; }

    #back { 
      position: fixed; top: 10px; left: 10px; z-index: 1000;
      background: #06c755; color: #fff; border: none; border-radius: 8px;
      padding: 8px 12px; display: none;
    }
    body.fullmap #back { display: inline-block; }

    /* 全画面時に出すフローティング操作ボタン */
    #fab {
      position: fixed;
      right: 12px;
      bottom: 16px;
      display: none;
      z-index: 1001;
      gap: 8px;
      flex-direction: column;
      align-items: end;
    }
    #fab button, #fab .pill {
      padding: 10px 14px;
      border: none;
      border-radius: 20px;
      background: #06c755;
      color: #fff;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,.2);
      white-space: nowrap;
      width: auto;
      cursor: pointer;
    }
    body.fullmap #fab { display: flex; }

    /* 天気バッジ（PC/スマホ両対応） */
    #weatherBadge {
      position: fixed;
      left: 12px;
      bottom: 16px;
      z-index: 1001;
      background: rgba(255,255,255,0.92);
      color: #222;
      border-radius: 12px;
      padding: 8px 12px;
      font-size: 13px;
      line-height: 1.4;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
      display: none;  /* 初期は非表示。取得後に表示 */
      min-width: 180px;
    }
    #weatherBadge .title{ font-weight:700; font-size:12px; color:#06c755; }
    #weatherBadge .row{ display:flex; gap:8px; flex-wrap:wrap; }

    /* レーダーコントロール */
    #radarCtl {
      display: flex; gap: 8px; align-items: center;
      background: rgba(0,0,0,0.65);
      color: #fff; padding: 8px 10px; border-radius: 12px;
    }
    #radarCtl input[type="range"]{ width: 140px; }
  </style>
</head>
<body>
  <header><h1>ライドツーリングツール</h1></header>

  <!-- 全画面時のみ見える戻るボタン -->
  <button id="back" type="button">戻る</button>

  <!-- 全画面時に表示されるフローティング操作 -->
  <div id="fab">
    <div id="radarCtl" style="display:none;">
      <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
        <input type="checkbox" id="radarToggle" />
        雨雲レーダー
      </label>
      <label style="display:flex;align-items:center;gap:6px;">
        透明度
        <input type="range" id="radarOpacity" min="0" max="100" value="70" />
      </label>
    </div>
    <button id="navBtnFab" disabled>Googleナビ開始</button>
    <button id="shareBtnFab" disabled>LINEで共有</button>
  </div>

  <!-- 左下の天気バッジ -->
  <div id="weatherBadge">
    <div class="title">現在の天気</div>
    <div class="row">
      <div id="wb-location">-</div>
      <div id="wb-temp">-℃</div>
      <div id="wb-rain">降水 - mm</div>
      <div id="wb-wind">風 - m/s</div>
    </div>
    <div style="font-size:11px;color:#666;">5〜10分ごとに更新</div>
  </div>

  <div class="panel">
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="start" placeholder="出発地を入力（例：京都駅）" style="flex:1">
      <button type="button" id="btn-loc" style="width:auto; white-space:nowrap;">現在地</button>
    </div>

    <input id="end" placeholder="目的地を入力（例：美山 かやぶきの里）">

    <div style="display:flex; gap:12px; align-items:center; margin:6px 0 10px">
      <label style="display:flex; gap:6px; align-items:center;">
        <input type="checkbox" id="opt-avoid-highways">
        高速を使わない
      </label>
      <label style="display:flex; gap:6px; align-items:center;">
        <input type="checkbox" id="opt-avoid-tolls">
        有料道路を使わない
      </label>
    </div>

    <button id="makeRoute">ルートを作る</button>
    <!-- パネルにもボタンを残す（全画面時は隠れる） -->
    <button id="shareBtn" disabled>LINEで共有</button>
    <button id="navBtn" disabled>Googleナビで開く</button>

    <!-- パネルでもレーダーON/OFFできる軽いトグル -->
    <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
      <label style="display:flex;gap:6px;align-items:center;">
        <input type="checkbox" id="radarTogglePanel" /> 雨雲レーダー表示
      </label>
    </div>
  </div>

  <div id="map"></div>

  <div class="panel" style="padding-top:8px">
    <div id="summary" style="font-size:14px;line-height:1.6;color:#333"></div>
  </div>

  <!-- LINE SDK（なければ無視してOK） -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = "2008438848-3gJlGQvy";
    (async function initLIFFSafe() {
      try {
        if (window.liff) {
          await liff.init({ liffId: LIFF_ID });
        }
      } catch (e) { console.warn('LIFF init skipped:', e); }
    })();
  </script>

  <!-- Google Maps API -->
  <script>
    let map, directionsService, directionsRenderer;
    let geocoder, currentMarker;

    /* 天気関連 */
    let weatherTimer = null;

    /* 雨雲レーダー関連（RainViewer） */
    let radarLayer = null;
    let radarTimestamp = null;     // 最新フレームのタイムスタンプ
    let radarTimer = null;         // 定期更新
    const RADAR_UPDATE_MS = 5 * 60 * 1000; // 5分ごと

    /* 端末判定 */
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  </script>
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlN9ik-Y3CpEy3Uw9hXfBq0m2AoZWx_oM&libraries=places&language=ja&callback=initMap"
    async defer></script>

  <script>
    /* クリックリスナー */
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('makeRoute').addEventListener('click', makeRoute);
      document.getElementById('shareBtn').addEventListener('click', shareOnLINE);
      document.getElementById('navBtn').addEventListener('click', openNavigation);
      document.getElementById('btn-loc').addEventListener('click', fillWithCurrentLocation);

      // フローティング側
      document.getElementById('shareBtnFab').addEventListener('click', shareOnLINE);
      document.getElementById('navBtnFab').addEventListener('click', openNavigation);

      // レーダーON/OFF（パネルとフローティングで同期）
      const syncRadar = (checked) => {
        document.getElementById('radarToggle').checked = checked;
        document.getElementById('radarTogglePanel').checked = checked;
        if (checked) { enableRadar(); } else { disableRadar(); }
      };
      document.getElementById('radarToggle').addEventListener('change', (e)=>syncRadar(e.target.checked));
      document.getElementById('radarTogglePanel').addEventListener('change', (e)=>syncRadar(e.target.checked));

      // レーダー透明度
      document.getElementById('radarOpacity').addEventListener('input', (e) => {
        const v = Number(e.target.value)/100;
        if (radarLayer) radarLayer.setOpacity(v);
      });

      // 戻る
      document.getElementById('back').addEventListener('click', () => {
        document.body.classList.remove('fullmap');
        if (window.google && map) google.maps.event.trigger(map, 'resize');
        document.getElementById('shareBtnFab').disabled = true;
        document.getElementById('navBtnFab').disabled   = true;
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });

    /* マップ初期化 */
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), { center: { lat: 35.0116, lng: 135.7681 }, zoom: 9 });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map });
      geocoder = new google.maps.Geocoder();

      // 初回の天気取得（地図中心で）
      refreshWeatherAt(map.getCenter());
      // 地図を動かしたら天気も更新（5秒待ってから）
      let weatherDebounce = null;
      map.addListener('idle', () => {
        clearTimeout(weatherDebounce);
        weatherDebounce = setTimeout(()=>refreshWeatherAt(map.getCenter()), 5000);
      });

      // レーダーUI（全画面時に表示）
      document.getElementById('radarCtl').style.display = 'flex';
    }

    /* 現在地 */
    function fillWithCurrentLocation() {
      if (!navigator.geolocation) { alert('この端末では位置情報が使えません'); return; }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          const loc = { lat, lng };

          map.setCenter(loc);
          map.setZoom(12);
          if (currentMarker) currentMarker.setMap(null);
          currentMarker = new google.maps.Marker({ position: loc, map, title: '現在地' });

          // 天気も更新
          refreshWeatherAt(loc);

          // 住所を出発地へ
          geocoder.geocode({ location: loc }, (results, status) => {
            if (status === 'OK' && results && results[0]) {
              document.getElementById('start').value = results[0].formatted_address;
            } else {
              document.getElementById('start').value = `${lat.toFixed(6)},${lng.toFixed(6)}`;
            }
          });
        },
        (err) => {
          const msg = {1:'位置情報の権限が拒否されました',2:'位置情報が取得できませんでした',3:'位置情報の取得がタイムアウトしました'}[err.code] || '位置情報の取得に失敗しました';
          alert(msg);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    /* ルート作成 */
    async function makeRoute() {
      const start = document.getElementById('start').value;
      const end   = document.getElementById('end').value;
      if (!start || !end) { alert('出発地と目的地を入力してください'); return; }

      const avoidHighways = document.getElementById('opt-avoid-highways').checked;
      const avoidTolls    = document.getElementById('opt-avoid-tolls').checked;

      const req = {
        origin: start,
        destination: end,
        travelMode: google.maps.TravelMode.DRIVING,
        avoidHighways,
        avoidTolls
      };

      directionsService.route(req, (result, status) => {
        if (status === 'OK') {
          directionsRenderer.setDirections(result);
          document.body.classList.add('fullmap');
          if (window.google && map) google.maps.event.trigger(map, 'resize');

          const leg = result.routes[0].legs[0];
          const s = document.getElementById('summary');
          const optTxt = `（高速: ${avoidHighways ? '使わない' : '使う'} / 有料: ${avoidTolls ? '使わない' : '使う'}）`;
          s.textContent = `距離: ${leg.distance.text}　時間: ${leg.duration.text} ${optTxt}`;

          const avoidParams = [];
          if (avoidHighways) avoidParams.push('highways');
          if (avoidTolls)    avoidParams.push('tolls');
          const avoidStr = avoidParams.length ? `&avoid=${avoidParams.join('%7C')}` : '';

          const gmapsUrl =
            'https://www.google.com/maps/dir/?api=1' +
            `&origin=${encodeURIComponent(leg.start_address)}` +
            `&destination=${encodeURIComponent(leg.end_address)}` +
            `&travelmode=driving${avoidStr}`;

          const gmapsNavUrl =
            'https://www.google.com/maps/dir/?api=1' +
            `&origin=${encodeURIComponent(leg.start_address)}` +
            `&destination=${encodeURIComponent(leg.end_address)}` +
            `&travelmode=driving&dir_action=navigate`;

          window._sharePayload = {
            text:
              `出発地: ${leg.start_address}\n` +
              `目的地: ${leg.end_address}\n` +
              `距離: ${leg.distance.text}\n` +
              `時間: ${leg.duration.text}\n` +
              `設定: 高速=${avoidHighways ? '使わない' : '使う'} / 有料=${avoidTolls ? '使わない' : '使う'}\n\n` +
              `ルートを見る: ${gmapsUrl}`,
            gmapsUrl,
            gmapsNavUrl
          };

          // ボタン有効化
          document.getElementById('shareBtn').disabled = false;
          document.getElementById('navBtn').disabled   = false;
          document.getElementById('shareBtnFab').disabled = false;
          document.getElementById('navBtnFab').disabled   = false;

          // 目的地付近の天気も更新
          refreshWeatherAt(leg.end_location);

        } else {
          alert('ルートを作れませんでした');
          document.getElementById('summary').textContent = '';
        }
      });
    }

    /* ナビ */
    function openNavigation() {
      if (!window._sharePayload) { alert('先にルートを作成してください。'); return; }
      const url = isMobile ? window._sharePayload.gmapsNavUrl : window._sharePayload.gmapsUrl;
      window.open(url, '_blank');
      if (!isMobile) {
        setTimeout(()=>alert('PCブラウザでは音声ナビは使えません。ブラウザで経路を開きました。'), 300);
      }
    }

    /* LINE共有 */
    async function shareOnLINE() {
      try {
        const payload = window._sharePayload;
        if (!payload) { alert('先に「ルートを作る」で経路を作成してください。'); return; }
        if (window.liff && liff.isInClient && liff.isInClient() && liff.isApiAvailable && liff.isApiAvailable('shareTargetPicker')) {
          try {
            const res = await liff.shareTargetPicker([{ type: 'text', text: payload.text }]);
            if (res) alert('送信しました！');
            return;
          } catch (e) { console.warn('shareTargetPicker失敗:', e); }
        }
        const shareUrl = 'https://line.me/R/share?text=' + encodeURIComponent(payload.text);
        window.open(shareUrl, '_blank');
      } catch (e) { alert('共有に失敗しました：\n' + (e?.message || String(e))); }
    }

    /* 天気取得（Open-Meteo） */
    async function refreshWeatherAt(latLng) {
      const lat = (typeof latLng.lat === 'function') ? latLng.lat() : latLng.lat;
      const lng = (typeof latLng.lng === 'function') ? latLng.lng() : latLng.lng;

      try {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,precipitation,wind_speed_10m&timezone=auto`;
        const res = await fetch(url);
        const data = await res.json();
        const cur = data.current;
        document.getElementById('wb-temp').textContent = `${Math.round(cur.temperature_2m)}℃`;
        document.getElementById('wb-rain').textContent = `降水 ${cur.precipitation ?? 0} mm`;
        document.getElementById('wb-wind').textContent = `風 ${cur.wind_speed_10m ?? 0} m/s`;

        // 逆ジオで大まかな地名
        geocoder.geocode({ location: {lat, lng} }, (results, status) => {
          const name = (status === 'OK' && results && results[0]) ? results[0].address_components?.find(c=>c.types.includes('locality'))?.long_name || results[0].formatted_address.split('、')[0] : `(${lat.toFixed(2)},${lng.toFixed(2)})`;
          document.getElementById('wb-location').textContent = name;
        });

        document.getElementById('weatherBadge').style.display = 'block';
        // 10分に一度更新
        if (weatherTimer) clearTimeout(weatherTimer);
        weatherTimer = setTimeout(()=>refreshWeatherAt({lat, lng}), 10*60*1000);
      } catch(e) {
        console.warn('天気取得失敗', e);
      }
    }

    /* 雨雲レーダー：ON */
    async function enableRadar() {
      try {
        // 最新フレームのタイムスタンプ取得
        const metaRes = await fetch('https://api.rainviewer.com/public/weather-maps.json');
        const meta = await metaRes.json();
        const frames = meta?.radar?.past || [];
        const last = frames[frames.length - 1];
        radarTimestamp = last?.time || null;

        if (!radarTimestamp) {
          alert('レーダーデータを取得できませんでした');
          document.getElementById('radarToggle').checked = false;
          document.getElementById('radarTogglePanel').checked = false;
          return;
        }

        // 既存レイヤーを外してから作成
        disableRadar();

        radarLayer = new google.maps.ImageMapType({
          getTileUrl: function(coord, zoom) {
            return `https://tilecache.rainviewer.com/v2/radar/${radarTimestamp}/256/${zoom}/${coord.x}/${coord.y}/2/1_1.png`;
          },
          tileSize: new google.maps.Size(256, 256),
          name: 'RainViewer',
          opacity: Number(document.getElementById('radarOpacity').value)/100,
          isPng: true
        });

        map.overlayMapTypes.insertAt(0, radarLayer);

        // 5分ごとに最新に差し替え
        if (radarTimer) clearInterval(radarTimer);
        radarTimer = setInterval(enableRadar, RADAR_UPDATE_MS);
      } catch (e) {
        console.warn('レーダー取得失敗', e);
        alert('雨雲レーダーの取得に失敗しました');
      }
    }

    /* 雨雲レーダー：OFF */
    function disableRadar() {
      if (radarTimer) { clearInterval(radarTimer); radarTimer = null; }
      if (map && radarLayer) {
        // overlayMapTypes から該当を探して削除
        for (let i=map.overlayMapTypes.getLength()-1; i>=0; i--) {
          const t = map.overlayMapTypes.getAt(i);
          if (t === radarLayer) { map.overlayMapTypes.removeAt(i); }
        }
        radarLayer = null;
      }
    }
  </script>

  <!-- 利用上のヒント：HTTPS必須（PCの現在地） -->
  <!-- ※PCで現在地ボタンを使うには、https で配信するか localhost での利用が必要です -->
</body>
</html><!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ライドツーリングツール（LINE × Google Maps）</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: sans-serif; }
    header { padding: 10px 16px; background: #06c755; color: white; }
    h1 { font-size: 18px; margin: 0; }
    #map { width: 100%; height: 60vh; }
    .panel { padding: 12px 16px; }
    input { padding: 8px; width: 100%; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 6px; }
    button { padding: 10px; font-size: 16px; border: none; border-radius: 8px; background: #06c755; color: white; width: 100%; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: default; }

    /* 全画面表示用スタイル */
    body.fullmap header,
    body.fullmap .panel { display: none; }
    body.fullmap #map { height: 100vh !important; }

    #back { 
      position: fixed; top: 10px; left: 10px; z-index: 1000;
      background: #06c755; color: #fff; border: none; border-radius: 8px;
      padding: 8px 12px; display: none;
    }
    body.fullmap #back { display: inline-block; }

    /* 全画面時に出すフローティング操作ボタン */
    #fab {
      position: fixed;
      right: 12px;
      bottom: 16px;
      display: none;
      z-index: 1001;
      gap: 8px;
      flex-direction: column;
      align-items: end;
    }
    #fab button, #fab .pill {
      padding: 10px 14px;
      border: none;
      border-radius: 20px;
      background: #06c755;
      color: #fff;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,.2);
      white-space: nowrap;
      width: auto;
      cursor: pointer;
    }
    body.fullmap #fab { display: flex; }

    /* 天気バッジ（PC/スマホ両対応） */
    #weatherBadge {
      position: fixed;
      left: 12px;
      bottom: 16px;
      z-index: 1001;
      background: rgba(255,255,255,0.92);
      color: #222;
      border-radius: 12px;
      padding: 8px 12px;
      font-size: 13px;
      line-height: 1.4;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
      display: none;  /* 初期は非表示。取得後に表示 */
      min-width: 180px;
    }
    #weatherBadge .title{ font-weight:700; font-size:12px; color:#06c755; }
    #weatherBadge .row{ display:flex; gap:8px; flex-wrap:wrap; }

    /* レーダーコントロール */
    #radarCtl {
      display: flex; gap: 8px; align-items: center;
      background: rgba(0,0,0,0.65);
      color: #fff; padding: 8px 10px; border-radius: 12px;
    }
    #radarCtl input[type="range"]{ width: 140px; }
  </style>
</head>
<body>
  <header><h1>ライドツーリングツール</h1></header>

  <!-- 全画面時のみ見える戻るボタン -->
  <button id="back" type="button">戻る</button>

  <!-- 全画面時に表示されるフローティング操作 -->
  <div id="fab">
    <div id="radarCtl" style="display:none;">
      <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
        <input type="checkbox" id="radarToggle" />
        雨雲レーダー
      </label>
      <label style="display:flex;align-items:center;gap:6px;">
        透明度
        <input type="range" id="radarOpacity" min="0" max="100" value="70" />
      </label>
    </div>
    <button id="navBtnFab" disabled>Googleナビ開始</button>
    <button id="shareBtnFab" disabled>LINEで共有</button>
  </div>

  <!-- 左下の天気バッジ -->
  <div id="weatherBadge">
    <div class="title">現在の天気</div>
    <div class="row">
      <div id="wb-location">-</div>
      <div id="wb-temp">-℃</div>
      <div id="wb-rain">降水 - mm</div>
      <div id="wb-wind">風 - m/s</div>
    </div>
    <div style="font-size:11px;color:#666;">5〜10分ごとに更新</div>
  </div>

  <div class="panel">
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="start" placeholder="出発地を入力（例：京都駅）" style="flex:1">
      <button type="button" id="btn-loc" style="width:auto; white-space:nowrap;">現在地</button>
    </div>

    <input id="end" placeholder="目的地を入力（例：美山 かやぶきの里）">

    <div style="display:flex; gap:12px; align-items:center; margin:6px 0 10px">
      <label style="display:flex; gap:6px; align-items:center;">
        <input type="checkbox" id="opt-avoid-highways">
        高速を使わない
      </label>
      <label style="display:flex; gap:6px; align-items:center;">
        <input type="checkbox" id="opt-avoid-tolls">
        有料道路を使わない
      </label>
    </div>

    <button id="makeRoute">ルートを作る</button>
    <!-- パネルにもボタンを残す（全画面時は隠れる） -->
    <button id="shareBtn" disabled>LINEで共有</button>
    <button id="navBtn" disabled>Googleナビで開く</button>

    <!-- パネルでもレーダーON/OFFできる軽いトグル -->
    <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
      <label style="display:flex;gap:6px;align-items:center;">
        <input type="checkbox" id="radarTogglePanel" /> 雨雲レーダー表示
      </label>
    </div>
  </div>

  <div id="map"></div>

  <div class="panel" style="padding-top:8px">
    <div id="summary" style="font-size:14px;line-height:1.6;color:#333"></div>
  </div>

  <!-- LINE SDK（なければ無視してOK） -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = "2008438848-3gJlGQvy";
    (async function initLIFFSafe() {
      try {
        if (window.liff) {
          await liff.init({ liffId: LIFF_ID });
        }
      } catch (e) { console.warn('LIFF init skipped:', e); }
    })();
  </script>

  <!-- Google Maps API -->
  <script>
    let map, directionsService, directionsRenderer;
    let geocoder, currentMarker;

    /* 天気関連 */
    let weatherTimer = null;

    /* 雨雲レーダー関連（RainViewer） */
    let radarLayer = null;
    let radarTimestamp = null;     // 最新フレームのタイムスタンプ
    let radarTimer = null;         // 定期更新
    const RADAR_UPDATE_MS = 5 * 60 * 1000; // 5分ごと

    /* 端末判定 */
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  </script>
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlN9ik-Y3CpEy3Uw9hXfBq0m2AoZWx_oM&libraries=places&language=ja&callback=initMap"
    async defer></script>

  <script>
    /* クリックリスナー */
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('makeRoute').addEventListener('click', makeRoute);
      document.getElementById('shareBtn').addEventListener('click', shareOnLINE);
      document.getElementById('navBtn').addEventListener('click', openNavigation);
      document.getElementById('btn-loc').addEventListener('click', fillWithCurrentLocation);

      // フローティング側
      document.getElementById('shareBtnFab').addEventListener('click', shareOnLINE);
      document.getElementById('navBtnFab').addEventListener('click', openNavigation);

      // レーダーON/OFF（パネルとフローティングで同期）
      const syncRadar = (checked) => {
        document.getElementById('radarToggle').checked = checked;
        document.getElementById('radarTogglePanel').checked = checked;
        if (checked) { enableRadar(); } else { disableRadar(); }
      };
      document.getElementById('radarToggle').addEventListener('change', (e)=>syncRadar(e.target.checked));
      document.getElementById('radarTogglePanel').addEventListener('change', (e)=>syncRadar(e.target.checked));

      // レーダー透明度
      document.getElementById('radarOpacity').addEventListener('input', (e) => {
        const v = Number(e.target.value)/100;
        if (radarLayer) radarLayer.setOpacity(v);
      });

      // 戻る
      document.getElementById('back').addEventListener('click', () => {
        document.body.classList.remove('fullmap');
        if (window.google && map) google.maps.event.trigger(map, 'resize');
        document.getElementById('shareBtnFab').disabled = true;
        document.getElementById('navBtnFab').disabled   = true;
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });

    /* マップ初期化 */
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), { center: { lat: 35.0116, lng: 135.7681 }, zoom: 9 });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map });
      geocoder = new google.maps.Geocoder();

      // 初回の天気取得（地図中心で）
      refreshWeatherAt(map.getCenter());
      // 地図を動かしたら天気も更新（5秒待ってから）
      let weatherDebounce = null;
      map.addListener('idle', () => {
        clearTimeout(weatherDebounce);
        weatherDebounce = setTimeout(()=>refreshWeatherAt(map.getCenter()), 5000);
      });

      // レーダーUI（全画面時に表示）
      document.getElementById('radarCtl').style.display = 'flex';
    }

    /* 現在地 */
    function fillWithCurrentLocation() {
      if (!navigator.geolocation) { alert('この端末では位置情報が使えません'); return; }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          const loc = { lat, lng };

          map.setCenter(loc);
          map.setZoom(12);
          if (currentMarker) currentMarker.setMap(null);
          currentMarker = new google.maps.Marker({ position: loc, map, title: '現在地' });

          // 天気も更新
          refreshWeatherAt(loc);

          // 住所を出発地へ
          geocoder.geocode({ location: loc }, (results, status) => {
            if (status === 'OK' && results && results[0]) {
              document.getElementById('start').value = results[0].formatted_address;
            } else {
              document.getElementById('start').value = `${lat.toFixed(6)},${lng.toFixed(6)}`;
            }
          });
        },
        (err) => {
          const msg = {1:'位置情報の権限が拒否されました',2:'位置情報が取得できませんでした',3:'位置情報の取得がタイムアウトしました'}[err.code] || '位置情報の取得に失敗しました';
          alert(msg);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    /* ルート作成 */
    async function makeRoute() {
      const start = document.getElementById('start').value;
      const end   = document.getElementById('end').value;
      if (!start || !end) { alert('出発地と目的地を入力してください'); return; }

      const avoidHighways = document.getElementById('opt-avoid-highways').checked;
      const avoidTolls    = document.getElementById('opt-avoid-tolls').checked;

      const req = {
        origin: start,
        destination: end,
        travelMode: google.maps.TravelMode.DRIVING,
        avoidHighways,
        avoidTolls
      };

      directionsService.route(req, (result, status) => {
        if (status === 'OK') {
          directionsRenderer.setDirections(result);
          document.body.classList.add('fullmap');
          if (window.google && map) google.maps.event.trigger(map, 'resize');

          const leg = result.routes[0].legs[0];
          const s = document.getElementById('summary');
          const optTxt = `（高速: ${avoidHighways ? '使わない' : '使う'} / 有料: ${avoidTolls ? '使わない' : '使う'}）`;
          s.textContent = `距離: ${leg.distance.text}　時間: ${leg.duration.text} ${optTxt}`;

          const avoidParams = [];
          if (avoidHighways) avoidParams.push('highways');
          if (avoidTolls)    avoidParams.push('tolls');
          const avoidStr = avoidParams.length ? `&avoid=${avoidParams.join('%7C')}` : '';

          const gmapsUrl =
            'https://www.google.com/maps/dir/?api=1' +
            `&origin=${encodeURIComponent(leg.start_address)}` +
            `&destination=${encodeURIComponent(leg.end_address)}` +
            `&travelmode=driving${avoidStr}`;

          const gmapsNavUrl =
            'https://www.google.com/maps/dir/?api=1' +
            `&origin=${encodeURIComponent(leg.start_address)}` +
            `&destination=${encodeURIComponent(leg.end_address)}` +
            `&travelmode=driving&dir_action=navigate`;

          window._sharePayload = {
            text:
              `出発地: ${leg.start_address}\n` +
              `目的地: ${leg.end_address}\n` +
              `距離: ${leg.distance.text}\n` +
              `時間: ${leg.duration.text}\n` +
              `設定: 高速=${avoidHighways ? '使わない' : '使う'} / 有料=${avoidTolls ? '使わない' : '使う'}\n\n` +
              `ルートを見る: ${gmapsUrl}`,
            gmapsUrl,
            gmapsNavUrl
          };

          // ボタン有効化
          document.getElementById('shareBtn').disabled = false;
          document.getElementById('navBtn').disabled   = false;
          document.getElementById('shareBtnFab').disabled = false;
          document.getElementById('navBtnFab').disabled   = false;

          // 目的地付近の天気も更新
          refreshWeatherAt(leg.end_location);

        } else {
          alert('ルートを作れませんでした');
          document.getElementById('summary').textContent = '';
        }
      });
    }

    /* ナビ */
    function openNavigation() {
      if (!window._sharePayload) { alert('先にルートを作成してください。'); return; }
      const url = isMobile ? window._sharePayload.gmapsNavUrl : window._sharePayload.gmapsUrl;
      window.open(url, '_blank');
      if (!isMobile) {
        setTimeout(()=>alert('PCブラウザでは音声ナビは使えません。ブラウザで経路を開きました。'), 300);
      }
    }

    /* LINE共有 */
    async function shareOnLINE() {
      try {
        const payload = window._sharePayload;
        if (!payload) { alert('先に「ルートを作る」で経路を作成してください。'); return; }
        if (window.liff && liff.isInClient && liff.isInClient() && liff.isApiAvailable && liff.isApiAvailable('shareTargetPicker')) {
          try {
            const res = await liff.shareTargetPicker([{ type: 'text', text: payload.text }]);
            if (res) alert('送信しました！');
            return;
          } catch (e) { console.warn('shareTargetPicker失敗:', e); }
        }
        const shareUrl = 'https://line.me/R/share?text=' + encodeURIComponent(payload.text);
        window.open(shareUrl, '_blank');
      } catch (e) { alert('共有に失敗しました：\n' + (e?.message || String(e))); }
    }

    /* 天気取得（Open-Meteo） */
    async function refreshWeatherAt(latLng) {
      const lat = (typeof latLng.lat === 'function') ? latLng.lat() : latLng.lat;
      const lng = (typeof latLng.lng === 'function') ? latLng.lng() : latLng.lng;

      try {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,precipitation,wind_speed_10m&timezone=auto`;
        const res = await fetch(url);
        const data = await res.json();
        const cur = data.current;
        document.getElementById('wb-temp').textContent = `${Math.round(cur.temperature_2m)}℃`;
        document.getElementById('wb-rain').textContent = `降水 ${cur.precipitation ?? 0} mm`;
        document.getElementById('wb-wind').textContent = `風 ${cur.wind_speed_10m ?? 0} m/s`;

        // 逆ジオで大まかな地名
        geocoder.geocode({ location: {lat, lng} }, (results, status) => {
          const name = (status === 'OK' && results && results[0]) ? results[0].address_components?.find(c=>c.types.includes('locality'))?.long_name || results[0].formatted_address.split('、')[0] : `(${lat.toFixed(2)},${lng.toFixed(2)})`;
          document.getElementById('wb-location').textContent = name;
        });

        document.getElementById('weatherBadge').style.display = 'block';
        // 10分に一度更新
        if (weatherTimer) clearTimeout(weatherTimer);
        weatherTimer = setTimeout(()=>refreshWeatherAt({lat, lng}), 10*60*1000);
      } catch(e) {
        console.warn('天気取得失敗', e);
      }
    }

    /* 雨雲レーダー：ON */
    async function enableRadar() {
      try {
        // 最新フレームのタイムスタンプ取得
        const metaRes = await fetch('https://api.rainviewer.com/public/weather-maps.json');
        const meta = await metaRes.json();
        const frames = meta?.radar?.past || [];
        const last = frames[frames.length - 1];
        radarTimestamp = last?.time || null;

        if (!radarTimestamp) {
          alert('レーダーデータを取得できませんでした');
          document.getElementById('radarToggle').checked = false;
          document.getElementById('radarTogglePanel').checked = false;
          return;
        }

        // 既存レイヤーを外してから作成
        disableRadar();

        radarLayer = new google.maps.ImageMapType({
          getTileUrl: function(coord, zoom) {
            return `https://tilecache.rainviewer.com/v2/radar/${radarTimestamp}/256/${zoom}/${coord.x}/${coord.y}/2/1_1.png`;
          },
          tileSize: new google.maps.Size(256, 256),
          name: 'RainViewer',
          opacity: Number(document.getElementById('radarOpacity').value)/100,
          isPng: true
        });

        map.overlayMapTypes.insertAt(0, radarLayer);

        // 5分ごとに最新に差し替え
        if (radarTimer) clearInterval(radarTimer);
        radarTimer = setInterval(enableRadar, RADAR_UPDATE_MS);
      } catch (e) {
        console.warn('レーダー取得失敗', e);
        alert('雨雲レーダーの取得に失敗しました');
      }
    }

    /* 雨雲レーダー：OFF */
    function disableRadar() {
      if (radarTimer) { clearInterval(radarTimer); radarTimer = null; }
      if (map && radarLayer) {
        // overlayMapTypes から該当を探して削除
        for (let i=map.overlayMapTypes.getLength()-1; i>=0; i--) {
          const t = map.overlayMapTypes.getAt(i);
          if (t === radarLayer) { map.overlayMapTypes.removeAt(i); }
        }
        radarLayer = null;
      }
    }
  </script>

  <!-- 利用上のヒント：HTTPS必須（PCの現在地） -->
  <!-- ※PCで現在地ボタンを使うには、https で配信するか localhost での利用が必要です -->
</body>
</html>

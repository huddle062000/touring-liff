<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ©ã‚¤ãƒ‰ãƒ„ãƒ¼ãƒªãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ï¼ˆLINE Ã— Google Mapsï¼‰</title>
  <style>
    :root{
      --navy:#1f4070; --accent:#06c755; --ink:#0f172a; --muted:#6b7280;
      --card:#ffffff; --shadow:0 6px 24px rgba(0,0,0,.16);
    }
    html,body{height:100%;margin:0;background:#f5f7fb;color:var(--ink);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif}
    #map{width:100%;height:100vh}

    /* ===== AppBarï¼ˆä¸Šï¼‰ ===== */
    .appbar{
      position:fixed;inset:0 0 auto 0;height:72px;background:var(--navy);color:#fff;z-index:1002;
      display:flex;align-items:center;justify-content:space-between;padding:0 12px 8px;
      box-shadow:0 2px 18px rgba(0,0,0,.25);
      clip-path: path("M0,0 H1000 V56 Q980,72 940,72 H60 Q20,72 0,56 Z");
    }
    .row{display:flex;align-items:center;gap:10px}
    .iconbtn{width:36px;height:36px;border-radius:18px;background:rgba(255,255,255,.12);
      display:grid;place-items:center;border:none;color:#fff;cursor:pointer}
    .home-chip{border-radius:16px;padding:8px 12px;background:rgba(255,255,255,.14);font-size:14px;cursor:pointer}

    /* ===== å…¥åŠ›ãƒ‘ãƒãƒ«ï¼ˆå‡ºç™º/ç›®çš„åœ°ï¼‰ ===== */
    .inputs{
      position:fixed;left:12px;right:12px;top:70px;z-index:1001;
      display:grid;gap:8px;grid-template-columns:1fr auto;
    }
    .pill{grid-column:1/-1;display:flex;align-items:center;gap:8px;background:#fff;border-radius:24px;
      padding:10px 14px;box-shadow:var(--shadow)}
    .pill label{font-size:12px;color:var(--muted);padding:4px 8px;background:#f3f4f6;border-radius:12px}
    .pill input{border:none;outline:none;flex:1;font-size:15px;background:transparent;min-width:60px}
    .swap{grid-column:2/3;grid-row:1/3;align-self:center;width:42px;height:42px;border-radius:21px;border:none;background:#fff;
      box-shadow:var(--shadow);cursor:pointer}

    /* ===== ãƒ«ãƒ¼ãƒˆä½œæˆã‚¿ãƒ– ===== */
    .route-tab{
      position:fixed;left:50%;top:136px;transform:translateX(-50%);
      background:var(--navy);color:#fff;border-radius:18px 18px 24px 24px;
      padding:10px 18px;z-index:1001;box-shadow:var(--shadow);display:flex;gap:6px;align-items:center
    }
    .route-menu{border:none;background:transparent;color:#fff;font-weight:700;font-size:18px;cursor:pointer}

    /* ===== å³ã®ã‚ºãƒ¼ãƒ /å³ä¸‹ç¾åœ¨åœ° ===== */
    .zoom-col{position:fixed;right:12px;top:180px;z-index:1001;display:flex;flex-direction:column;gap:10px}
    .zoom-btn{width:48px;height:48px;border-radius:12px;background:#fff;border:none;box-shadow:var(--shadow);font-size:24px;cursor:pointer}
    .loc-btn{position:fixed;right:12px;bottom:18px;z-index:1001;width:62px;height:62px;border-radius:31px;background:#fff;border:none;
      box-shadow:var(--shadow);cursor:pointer;display:grid;place-items:center;font-size:22px}

    /* ===== å·¦ã®ã‚ªãƒ¼ãƒ—ãƒŠãƒ¼ï¼ˆï¼ï¼‰ ===== */
    .drawer-open{position:fixed;left:8px;top:180px;z-index:1001;width:36px;height:56px;border:none;border-radius:18px;
      background:#fff;box-shadow:var(--shadow);cursor:pointer}

    /* ===== å·¦ã‹ã‚‰å‡ºã‚‹ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ ===== */
    .drawer{
      position:fixed;left:0;top:0;bottom:0;width:300px;background:#fff;z-index:1100;
      transform:translateX(-100%);transition:transform .25s ease;box-shadow:var(--shadow);padding:16px 14px 20px
    }
    .drawer.open{transform:translateX(0)}
    .drawer h3{margin:4px 0 12px 0}
    .opt{display:flex;align-items:center;gap:10px;margin:10px 0}
    .opt input{width:18px;height:18px}
    .primary{width:100%;border:none;border-radius:12px;background:var(--accent);color:#fff;padding:12px 14px;font-size:16px;cursor:pointer}
    .muted{border:none;background:#f3f4f6;color:#111;padding:8px 10px;border-radius:10px;cursor:pointer}

    /* ===== é›¨é›²ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ï¼ˆç¶™ç¶šï¼‰ ===== */
    #rvCtl{
      position:fixed;left:12px;bottom:12px;z-index:1002;background:#fff;border-radius:14px;padding:12px 14px;
      box-shadow:var(--shadow);min-width:240px;display:none
    }
    #rvCtl header{font-weight:700;margin-bottom:6px}
    #rvCtl .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    #rvCtl button{border:none;border-radius:10px;padding:8px 10px;background:var(--accent);color:#fff;cursor:pointer}
    #rvCtl button.gray{background:#9ca3af}
    #rvCtl input[type="range"]{width:130px}
  </style>
</head>
<body>
  <!-- App bar -->
  <div class="appbar">
    <div class="row">
      <button class="iconbtn" id="btnMenu" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">â˜°</button>
      <div class="home-chip" id="btnHome">è‡ªå®…</div>
    </div>
    <div></div>
  </div>

  <!-- å…¥åŠ›ï¼ˆå‡ºç™º/ç›®çš„åœ°ï¼‰ -->
  <div class="inputs">
    <div class="pill">
      <label>å‡ºç™ºåœ°</label>
      <input id="start" placeholder="ä¾‹ï¼šç¾åœ¨åœ° / äº¬éƒ½é§…">
    </div>
    <div class="pill">
      <label>ç›®çš„åœ°</label>
      <input id="end" placeholder="ä¾‹ï¼šç¾å±± ã‹ã‚„ã¶ãã®é‡Œ">
    </div>
    <button class="swap" id="btnSwap" title="å…¥ã‚Œæ›¿ãˆ">â‡…</button>
  </div>

  <!-- ãƒ«ãƒ¼ãƒˆä½œæˆ -->
  <div class="route-tab">
    <button class="route-menu" id="makeRoute">ãƒ«ãƒ¼ãƒˆä½œæˆ â–¾</button>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- å³ï¼šã‚ºãƒ¼ãƒ  & ç¾åœ¨åœ° -->
  <div class="zoom-col">
    <button class="zoom-btn" id="zoomIn">ï¼‹</button>
    <button class="zoom-btn" id="zoomOut">ï¼</button>
  </div>
  <button class="loc-btn" id="btnLocate" title="ç¾åœ¨åœ°ã¸">â¤</button>

  <!-- å·¦ï¼šã‚ªãƒ¼ãƒ—ãƒŠãƒ¼ï¼ˆï¼ï¼‰ -->
  <button class="drawer-open" id="btnDrawer">&gt;</button>

  <!-- ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆå·¦ã‹ã‚‰ï¼‰ -->
  <aside class="drawer" id="drawer">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
      <button class="muted" id="btnDrawerClose">é–‰ã˜ã‚‹</button>
    </div>

    <button class="primary" id="shareBtn">LINEã§ãƒ«ãƒ¼ãƒˆã‚’å…±æœ‰</button>

    <div class="opt">
      <input type="checkbox" id="useHighways" checked>
      <label for="useHighways">é«˜é€Ÿé“è·¯ã‚’ä½¿ã†</label>
    </div>
    <div class="opt">
      <input type="checkbox" id="useTolls" checked>
      <label for="useTolls">æœ‰æ–™é“è·¯ã‚’ä½¿ã†</label>
    </div>

    <!-- å¿…è¦ãªã‚‰é›¨é›²ãƒˆã‚°ãƒ«ã‚’ã“ã“ã«ã‚‚è¿½åŠ ã§ãã¾ã™ -->
    <div style="margin-top:12px">
      <button class="muted" id="btnRain">é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼</button>
    </div>
  </aside>

  <!-- é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼UI -->
  <div id="rvCtl">
    <header>é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ <span class="stamp" id="rvStamp">--:--</span></header>
    <div class="row">
      <button id="rvPlay">â–¶ï¸ å†ç”Ÿ</button>
      <button id="rvPrev">â—€ï¸</button>
      <button id="rvNext">â–¶ï¸</button>
      <button id="rvOff" class="gray">OFF</button>
    </div>
    <div class="row" style="margin-top:6px">
      é€æ˜åº¦ <input id="rvOpacity" type="range" min="20" max="100" value="60">
      <span id="rvOpacityVal">60%</span>
    </div>
  </div>

  <!-- Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlN9ik-Y3CpEy3Uw9hXfBq0m2AoZWx_oM&libraries=places&language=ja&region=JP&callback=initMap" async defer></script>

  <script>
    let map, directionsService, directionsRenderer;
    let radarTimestamps=[], radarIndex=0, radarTimer=null, radarLayer=null, radarOpacity=0.6;

    function initMap(){
      map=new google.maps.Map(document.getElementById('map'),{
        center:{lat:35.0116,lng:135.7681},zoom:12,streetViewControl:false,mapTypeControl:false,fullscreenControl:false
      });
      directionsService=new google.maps.DirectionsService();
      directionsRenderer=new google.maps.DirectionsRenderer({map});

      // ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ
      new google.maps.places.Autocomplete(document.getElementById('start'),{fields:["geometry","name"]});
      new google.maps.places.Autocomplete(document.getElementById('end'),{fields:["geometry","name"]});

      // ã‚ºãƒ¼ãƒ 
      document.getElementById('zoomIn').onclick=()=>map.setZoom(map.getZoom()+1);
      document.getElementById('zoomOut').onclick=()=>map.setZoom(map.getZoom()-1);

      // ç¾åœ¨åœ°
      document.getElementById('btnLocate').onclick=getCurrentPosition;
      document.getElementById('btnHome').onclick=getCurrentPosition;

      // å…¥ã‚Œæ›¿ãˆ
      document.getElementById('btnSwap').onclick=()=>{
        const s=document.getElementById('start'), e=document.getElementById('end');
        [s.value,e.value]=[e.value,s.value];
      };

      // ãƒ«ãƒ¼ãƒˆä½œæˆ
      document.getElementById('makeRoute').onclick=buildRoute;

      // ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰
      const drawer=document.getElementById('drawer');
      document.getElementById('btnDrawer').onclick=()=>drawer.classList.add('open');
      document.getElementById('btnDrawerClose').onclick=()=>drawer.classList.remove('open');

      // å…±æœ‰
      document.getElementById('shareBtn').onclick=shareRoute;

      // é›¨é›²
      document.getElementById('btnRain').onclick=toggleRadar;
      document.getElementById('rvPlay').addEventListener('click',(e)=>togglePlay(e.currentTarget));
      document.getElementById('rvPrev').addEventListener('click',()=>stepFrame(-1));
      document.getElementById('rvNext').addEventListener('click',()=>stepFrame(1));
      document.getElementById('rvOff').addEventListener('click',turnRadarOff);
      document.getElementById('rvOpacity').addEventListener('input',(e)=>{
        const v=Number(e.target.value); document.getElementById('rvOpacityVal').textContent=v+'%';
        radarOpacity=v/100; if(radarLayer) rebuildCurrentRadarLayer();
      });
    }

    function getCurrentPosition(){
      if(!navigator.geolocation){alert('ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“');return;}
      navigator.geolocation.getCurrentPosition(pos=>{
        const p={lat:pos.coords.latitude,lng:pos.coords.longitude};
        map.panTo(p); map.setZoom(Math.max(map.getZoom(),14));
        const s=document.getElementById('start'); s.value=`${p.lat.toFixed(6)},${p.lng.toFixed(6)}`;
      },()=>alert('ç¾åœ¨åœ°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'));
    }

    async function buildRoute(){
      const startVal=document.getElementById('start').value.trim();
      const endVal=document.getElementById('end').value.trim();
      if(!endVal){alert('ç›®çš„åœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}

      const useHighways=document.getElementById('useHighways').checked;
      const useTolls=document.getElementById('useTolls').checked;

      const req={
        origin: startVal || 'ç¾åœ¨åœ°',
        destination: endVal,
        travelMode: google.maps.TravelMode.DRIVING,
        drivingOptions:{departureTime:new Date()},
        avoidHighways: !useHighways,
        avoidTolls: !useTolls,
        provideRouteAlternatives:false
      };

      try{
        if(!startVal && navigator.geolocation){
          await new Promise((resolve,reject)=>{
            navigator.geolocation.getCurrentPosition(p=>{
              req.origin=new google.maps.LatLng(p.coords.latitude,p.coords.longitude);
              resolve();
            },reject,{enableHighAccuracy:true,timeout:7000});
          });
        }
        const res=await directionsService.route(req);
        directionsRenderer.setDirections(res);
      }catch(e){ console.error(e); alert('ãƒ«ãƒ¼ãƒˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    }

    function buildMapsUrl(){
      const s=document.getElementById('start').value.trim();
      const e=document.getElementById('end').value.trim();
      const useHighways=document.getElementById('useHighways').checked;
      const useTolls=document.getElementById('useTolls').checked;
      const avoidHighways = (!useHighways) ? 1 : 0;
      const avoidTolls    = (!useTolls)    ? 1 : 0;

      // Googleãƒãƒƒãƒ—ã®Directions URLï¼ˆwebï¼‰
      const params=new URLSearchParams({
        api:1,
        origin: s||'Current+Location',
        destination: e||'',
        travelmode:'driving',
      });
      // Googleãƒãƒƒãƒ—URLã«ã¯avoidã‚’å€‹åˆ¥æŒ‡å®šã§ããªã„ãŸã‚ã€queryã§ãƒ’ãƒ³ãƒˆã‚’ä»˜ä¸
      let q=[];
      if(avoidHighways) q.push('é«˜é€Ÿã‚’ä½¿ã‚ãªã„');
      if(avoidTolls)    q.push('æœ‰æ–™é“è·¯ã‚’ä½¿ã‚ãªã„');
      if(q.length) params.set('query', q.join(' '));
      return `https://www.google.com/maps/dir/?${params.toString()}`;
    }

    async function shareRoute(){
      const url=buildMapsUrl();
      const text='ãƒ„ãƒ¼ãƒªãƒ³ã‚°ã®ãƒ«ãƒ¼ãƒˆå€™è£œã§ã™ğŸ‘‡';
      // Web Share â†’ LINE(share target) or ç›´æ¥LINE URL
      if(navigator.share){
        try{ await navigator.share({title:'ãƒ«ãƒ¼ãƒˆå…±æœ‰',text, url}); return;}catch{}
      }
      // LINEã®ãƒˆãƒ¼ã‚¯å…±æœ‰ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰
      const encoded = encodeURIComponent(`${text}\n${url}`);
      window.open(`https://line.me/R/share?text=${encoded}`, '_blank');
    }

    /* ===== é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ ===== */
    async function toggleRadar(){
      const ctl=document.getElementById('rvCtl');
      if(radarLayer){ turnRadarOff(); return; }
      try{
        const res=await fetch('https://api.rainviewer.com/public/weather-maps.json');
        const data=await res.json();
        radarTimestamps=[...(data?.radar?.past||[]).map(f=>f.time),...(data?.radar?.nowcast||[]).map(f=>f.time)];
        if(!radarTimestamps.length){ alert('é›¨é›²ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—'); return; }
        radarIndex=radarTimestamps.length-1;
        fadeToFrame(radarIndex,true);
        ctl.style.display='block';
      }catch(e){ alert('é›¨é›²ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼'); console.error(e); }
    }
    function turnRadarOff(){ stopAnimation(); map.overlayMapTypes.clear(); radarLayer=null; document.getElementById('rvCtl').style.display='none'; }
    function tileUrl(ts){ return `https://tilecache.rainviewer.com/v2/radar/${ts}/256/{z}/{x}/{y}/2/1_1.png`; }
    function buildLayer(ts,opacity){
      const t=tileUrl(ts);
      return new google.maps.ImageMapType({
        getTileUrl:(coord,zoom)=>{ const n=1<<zoom; let x=coord.x%n; if(x<0)x+=n; return t.replace('{z}',zoom).replace('{x}',x).replace('{y}',coord.y); },
        tileSize:new google.maps.Size(256,256), opacity:opacity
      });
    }
    function fadeToFrame(i,instant=false){
      if(!radarTimestamps.length) return;
      const ts=radarTimestamps[i];
      const newLayer=buildLayer(ts,0);
      map.overlayMapTypes.insertAt(0,newLayer);

      const d=new Date(ts*1000);
      document.getElementById('rvStamp').textContent=d.toLocaleString('ja-JP',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});

      const oldLayer=radarLayer; radarLayer=newLayer;
      if(instant){ radarLayer.setOpacity(radarOpacity); if(oldLayer) map.overlayMapTypes.removeAt(1); return; }

      let alpha=0;
      const fadeTimer=setInterval(()=>{
        alpha+=0.1;
        radarLayer.setOpacity(radarOpacity*alpha);
        if(oldLayer) oldLayer.setOpacity(radarOpacity*(1-alpha));
        if(alpha>=1){ clearInterval(fadeTimer); radarLayer.setOpacity(radarOpacity);
          if(oldLayer){ const arr=map.overlayMapTypes.getArray(); const idx=arr.indexOf(oldLayer); if(idx>=0) map.overlayMapTypes.removeAt(idx); }
        }
      },50);
    }
    function rebuildCurrentRadarLayer(){ if(radarLayer) fadeToFrame(radarIndex,true); }
    function stepFrame(dir){ if(!radarTimestamps.length) return; radarIndex=(radarIndex+dir+radarTimestamps.length)%radarTimestamps.length; fadeToFrame(radarIndex); }
    function togglePlay(btn){
      if(radarTimer){ clearInterval(radarTimer); radarTimer=null; btn.textContent='â–¶ï¸ å†ç”Ÿ'; return; }
      btn.textContent='â¸ ä¸€æ™‚åœæ­¢'; radarTimer=setInterval(()=>stepFrame(1),380);
    }
    function stopAnimation(){ if(radarTimer){ clearInterval(radarTimer); radarTimer=null; } const btn=document.getElementById('rvPlay'); if(btn) btn.textContent='â–¶ï¸ å†ç”Ÿ'; }
  </script>
</body>
</html>
